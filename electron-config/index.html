<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Electron Configuration Trainer</title>
<style>
/* ======== GLOBAL LAYOUT ======== */
html,body{
  margin:0;
  padding:0;
  font-family:system-ui,Arial,sans-serif;
  background:#f6f7f9;
  color:#111;
  height:100%;
}
body{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  min-height:100vh;
}
h1,h2,h3{margin:0;padding:0;font-weight:600;}
#mainWrap{
  width:100%;
  max-width:1250px;
  margin:0 auto;
  padding:16px;
  box-sizing:border-box;
}
button{
  cursor:pointer;
  font-weight:600;
}
.btn{
  background:#111;
  color:#fff;
  border:1px solid #111;
  border-radius:8px;
  padding:.4rem .9rem;
}
.btn-ghost{
  background:#fff;
  border:1px solid #ccc;
  border-radius:8px;
  padding:.35rem .8rem;
}
input[type=text],select{
  padding:.4rem .5rem;
  border:1px solid #ccc;
  border-radius:8px;
}
.badge{
  background:#eef;
  color:#223;
  font-size:.8rem;
  border-radius:12px;
  padding:.15rem .5rem;
}
.flex{display:flex;align-items:center;gap:8px;}
.card{
  background:#fff;
  border:1px solid #ddd;
  border-radius:12px;
  padding:12px 14px;
  box-shadow:0 1px 3px rgba(0,0,0,.05);
}
.mut{color:#555;font-size:.85rem;}
.hidden{display:none;}
strong{font-weight:700;}
/* ======== ORBITAL GRID ======== */
#orbitalGrid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  grid-gap:6px;
  margin-top:14px;
}
.orbCol{
  background:#fafafa;
  border:1px solid #ccc;
  border-radius:8px;
  min-height:120px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding:6px;
}
.orbHeader{font-weight:600;font-size:.9rem;margin-bottom:4px;}
.orbSlot{
  width:90%;
  min-height:20px;
  border:1px dashed #999;
  margin:2px 0;
  border-radius:4px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}
.arrow{
  width:14px;
  height:14px;
  background:#111;
  border-radius:2px;
  margin:1px;
}
.arrow.up{clip-path:polygon(50% 0,100% 100%,0 100%);}
.arrow.down{clip-path:polygon(0 0,100% 0,50% 100%);}
.filled{background:#3a8bff;}
.orbCol.s{background:#e8f0ff;}
.orbCol.p{background:#e6ffe6;}
.orbCol.d{background:#fff3e6;}
.orbCol.f{background:#f4e6ff;}
/* ======== CONTROL BAR ======== */
#controlBar{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:10px;
  margin-top:8px;
}
#controlBar select,#controlBar button{font-size:.9rem;}
/* ======== PANELS ======== */
#configPanel{
  display:flex;
  flex-direction:row;
  gap:12px;
  align-items:flex-start;
  justify-content:space-between;
  width:100%;
  margin-top:16px;
}
#infoBox{flex:1;}
#answerBox{
  flex:1;
  display:none;
}
#answerBox.show{display:block;}
#answerBox h3{margin-top:0;}
#answerOutput{
  white-space:pre-line;
  font-family:monospace;
  background:#fafafa;
  border:1px solid #ccc;
  padding:8px;
  border-radius:6px;
}
/* ======== PERIODIC TABLE ======== */
#ptable{
  display:grid;
  grid-template-columns:repeat(18,1fr);
  grid-gap:2px;
  margin-top:8px;
  font-size:10px;
}
.ptcell{
  height:28px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid #ccc;
  border-radius:3px;
}
.ptcell.s{background:#cde1ff;}
.ptcell.p{background:#cbffcb;}
.ptcell.d{background:#ffe1b3;}
.ptcell.f{background:#e9cbff;}
.ptcell span{pointer-events:none;}
/* ======== FLOATING TRAY ======== */
#tray{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#111;
  color:#fff;
  padding:8px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 -3px 10px rgba(0,0,0,.25);
  z-index:200;
}
#tray button{
  background:#fff;
  color:#111;
  font-size:.85rem;
  border-radius:8px;
  padding:.3rem .7rem;
}
/* ======== TEACHER PORTAL BUTTON ======== */
#tpBtnTeacher{
  position:fixed;
  bottom:18px;
  right:20px;
  width:52px;
  height:52px;
  background:#1e1e1e;
  color:#fff;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  cursor:pointer;
  z-index:9999;
  box-shadow:0 3px 8px rgba(0,0,0,.4);
}
#tpBtnTeacher:hover{background:#333;}
dialog{border:none;border-radius:12px;padding:16px;}
dialog::backdrop{background:rgba(0,0,0,.45);}
</style>
</head>
<body>
<div id="mainWrap">
  <header class="flex" style="justify-content:space-between;margin-bottom:12px;">
    <div class="flex" style="gap:10px;">
      <h1>Electron Configuration Trainer</h1>
      <span class="badge" id="statusBadge">offline</span>
    </div>
    <div class="flex">
      <input id="elementInput" type="text" placeholder="Element (e.g. Fe)" style="width:90px;text-align:center;" maxlength="3">
      <select id="modeSelect">
        <option value="build">Build Mode</option>
        <option value="quiz">Quiz Mode</option>
      </select>
      <button id="startBtn" class="btn">Start</button>
      <button id="showAnsBtn" class="btn-ghost">Show Answers</button>
    </div>
  </header>

  <section id="controlBar">
    <div>Electron Count: <strong id="eCount">0</strong></div>
    <div>Expected: <strong id="eExpected">—</strong></div>
    <button id="clearBtn" class="btn-ghost">Clear</button>
    <button id="checkBtn" class="btn-ghost">Check</button>
  </section>

  <div id="configPanel">
    <div id="infoBox" class="card" style="flex:1;">
      <h3>Configuration</h3>
      <div id="orbitalGrid"></div>
    </div>
    <div id="answerBox" class="card">
      <h3>Answer Key & Periodic Table</h3>
      <div id="answerOutput"></div>
      <div id="ptable"></div>
    </div>
  </div>
</div>

<div id="tray">
  <div>Electrons placed: <strong id="trayCount">0</strong></div>
  <div class="flex">
    <button id="loginTeacher">Teacher Login</button>
    <button id="resetAll">Reset</button>
  </div>
</div>

<div id="tpBtnTeacher" title="Teacher Portal">T</div>

<script>
// ======== STATE ========
let elementSymbol="",expectedElectrons=0,currentElectrons=0;
let orbitals=[];
const electronSet={};
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));

/* ======== PERIODIC TABLE DATA ======== */
const PT_ROWS=[
["H",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"He"],
["Li","Be",null,null,null,null,null,null,null,null,null,null,"B","C","N","O","F","Ne"],
["Na","Mg",null,null,null,null,null,null,null,null,null,null,"Al","Si","P","S","Cl","Ar"],
["K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr"],
["Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe"],
["Cs","Ba","La","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn"],
["Fr","Ra","Ac","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"]
];
/* ======== BUILD ORBITAL GRID ======== */
const ORBITAL_ORDER=[
  "1s","2s","2p","3s","3p","4s","3d","4p","5s","4d","5p","6s","4f","5d","6p","7s","5f","6d","7p"
];
function buildOrbitals(){
  const grid=$("#orbitalGrid"); grid.innerHTML="";
  orbitals=[];
  ORBITAL_ORDER.forEach(label=>{
    const col=document.createElement("div");
    const block=label.replace(/[0-9]/g,"");
    col.className=`orbCol ${block}`;
    const hdr=document.createElement("div");
    hdr.className="orbHeader";
    hdr.textContent=label;
    col.appendChild(hdr);
    const max={
      s:2,p:6,d:10,f:14
    }[block];
    const slots=Math.ceil(max/2);
    for(let i=0;i<slots;i++){
      const slot=document.createElement("div");
      slot.className="orbSlot";
      slot.dataset.label=label;
      slot.dataset.index=i;
      slot.ondragover=e=>e.preventDefault();
      slot.ondrop=dropElectron;
      col.appendChild(slot);
    }
    grid.appendChild(col);
    orbitals.push({label,block,max});
  });
}

/* ======== ELECTRON CREATION ======== */
function createElectron(id){
  const e=document.createElement("div");
  e.className="arrow up";
  e.draggable=true;
  e.id=id;
  e.ondragstart=dragElectron;
  return e;
}
function dragElectron(ev){
  ev.dataTransfer.setData("text/plain",ev.target.id);
}
function dropElectron(ev){
  ev.preventDefault();
  const id=ev.dataTransfer.getData("text/plain");
  const ele=document.getElementById(id);
  if(!ele)return;
  const slot=ev.currentTarget;
  if(slot.children.length>=2)return; // two per slot
  slot.appendChild(ele);
  updateElectronCount();
}

/* ======== ELECTRON CONTROL ======== */
function clearGrid(){
  $$("#orbitalGrid .arrow").forEach(a=>a.remove());
  currentElectrons=0;
  $("#eCount").textContent="0";
  $("#trayCount").textContent="0";
}
function addElectron(){
  const id=`e${Date.now()}${Math.floor(Math.random()*9999)}`;
  const e=createElectron(id);
  $("#orbitalGrid").appendChild(e);
}

/* ======== COUNT & VALIDATION ======== */
function updateElectronCount(){
  currentElectrons=$$("#orbitalGrid .arrow").length;
  $("#eCount").textContent=currentElectrons;
  $("#trayCount").textContent=currentElectrons;
}
function checkAnswer(){
  if(currentElectrons===expectedElectrons){
    alert("Configuration appears complete!");
  }else if(currentElectrons>expectedElectrons){
    alert("Too many electrons! ("+currentElectrons+"/"+expectedElectrons+")");
  }else{
    alert("Still missing electrons ("+currentElectrons+"/"+expectedElectrons+")");
  }
}

/* ======== PERIODIC TABLE RENDER ======== */
function renderTable(){
  const tbl=$("#ptable"); tbl.innerHTML="";
  PT_ROWS.forEach(r=>{
    r.forEach(sym=>{
      const div=document.createElement("div");
      div.className="ptcell";
      if(!sym){div.style.visibility="hidden";tbl.appendChild(div);return;}
      let block="s";
      if(["He","Ne","Ar","Kr","Xe","Rn","Og","F","Cl","Br","I","At","O","S","Se","Te"].includes(sym))block="p";
      if(["Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn"].includes(sym))block="d";
      if(["La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr"].includes(sym))block="f";
      div.classList.add(block);
      div.innerHTML=`<span>${sym}</span>`;
      tbl.appendChild(div);
    });
  });
}
renderTable();

/* ======== ELEMENT ELECTRON COUNTS ======== */
const ELECTRON_COUNTS={
  H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,
  K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,
  Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,
  Cs:55,Ba:56,La:57,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86
};
function setElement(sym){
  elementSymbol=sym;
  expectedElectrons=ELECTRON_COUNTS[sym]||0;
  $("#eExpected").textContent=expectedElectrons?expectedElectrons:"—";
}

/* ======== BUTTON ACTIONS ======== */
$("#startBtn").onclick=()=>{
  const sym=$("#elementInput").value.trim();
  if(!sym){alert("Enter an element symbol.");return;}
  setElement(sym);
  clearGrid();
};
$("#clearBtn").onclick=clearGrid;
$("#resetAll").onclick=clearGrid;
$("#checkBtn").onclick=checkAnswer;

/* ======== SHOW ANSWERS ======== */
$("#showAnsBtn").onclick=()=>{
  const ansBox=$("#answerBox");
  ansBox.classList.toggle("show");
  if(ansBox.classList.contains("show")){
    const sym=$("#elementInput").value.trim();
    if(!sym){alert("Enter an element first.");return;}
    const ecount=ELECTRON_COUNTS[sym]||0;
    $("#answerOutput").textContent=generateConfig(sym,ecount);
    highlightElement(sym);
  }
};

/* ======== CONFIG GENERATION ======== */
function generateConfig(sym,n){
  // simple aufbau order filling
  const order=["1s2","2s2","2p6","3s2","3p6","4s2","3d10","4p6","5s2","4d10","5p6","6s2","4f14","5d10","6p6","7s2","5f14","6d10","7p6"];
  let count=n; let out=[];
  for(const o of order){
    const cap=parseInt(o.match(/\d+/g)[1]||o.replace(/\D/g,""));
    if(count<=0)break;
    let fill=Math.min(cap,count);
    const base=o.replace(/\d+/g,"");
    const label=o.match(/([0-9][spdf])/)[1];
    out.push(label+fill);
    count-=fill;
  }
  return `${sym}: ${out.join(" ")}`;
}

/* ======== HIGHLIGHT ELEMENT ======== */
function highlightElement(sym){
  $$("#ptable .ptcell").forEach(c=>{
    const s=c.textContent.trim();
    c.style.outline=(s===sym)?"2px solid red":"none";
  });
}

/* ======== INIT ======== */
window.addEventListener("load",()=>{
  buildOrbitals();
  renderTable();
});
/* ======== FIREBASE CONFIG ======== */
const firebaseConfig = {
  apiKey: "AIzaSyAal8uHe9nePGimXiRPZAnBl0ucQlKnXNo",
  authDomain: "presentation-83d1f.firebaseapp.com",
  databaseURL: "https://presentation-83d1f-default-rtdb.firebaseio.com",
  projectId: "presentation-83d1f",
  storageBucket: "presentation-83d1f.firebasestorage.app",
  messagingSenderId: "132406143951",
  appId: "1:132406143951:web:9695690023bd3f2aedc0ba"
};

let fb = { app:null, db:null, auth:null };
let live = { classKey:null, sessionId:null, teacherPin:null, me:null };
const DBPATH = c => `/classes/${live.classKey}/${c}`;

/* ======== INIT FIREBASE ======== */
function initFirebase(){
  if(!firebase.apps.length){
    fb.app = firebase.initializeApp(firebaseConfig);
  }
  fb.db = firebase.database();
  fb.auth = firebase.auth();
  fb.auth.signInAnonymously().catch(console.error);
  $("#statusBadge").textContent = "online (firebase)";
}

/* ======== CLASS + PIN MGMT ======== */
function sanitizeKey(k){
  return (k||"").trim().toUpperCase().replace(/[^A-Z0-9\-]/g,"-").slice(0,24)||"CLASS";
}
async function setClassKey(k){
  live.classKey = sanitizeKey(k);
  localStorage.setItem("ec_class", live.classKey);
}
async function fetchPin(){
  const snap = await fb.db.ref(DBPATH("config/pin")).get();
  return (snap.exists() && snap.val()) || null;
}
async function savePin(pin){
  await fb.db.ref(DBPATH("config")).update({pin});
}
function validPin(p){ return /^\d{4}$/.test(p); }

/* ======== LOGIN DIALOG ======== */
const tpBtn = $("#tpBtnTeacher");
const dlg = document.createElement("dialog");
dlg.innerHTML = `
  <form method="dialog" style="padding:16px;max-width:320px">
    <h3>Teacher Login</h3>
    <p class="mut">Enter or set your 4-digit PIN</p>
    <input id="pinInput" type="password" inputmode="numeric" maxlength="4" 
      style="width:100%;padding:.6rem;border:1px solid #ccc;border-radius:10px" />
    <div class="flex" style="justify-content:space-between;margin-top:10px">
      <button id="pinSubmit" class="btn">Enter</button>
      <button id="pinSet" class="btn-ghost" type="button">Save</button>
      <button id="closeDlg" class="btn-ghost">Close</button>
    </div>
  </form>`;
document.body.appendChild(dlg);

tpBtn.onclick = ()=> dlg.showModal();
$("#loginTeacher").onclick = ()=> dlg.showModal();
dlg.querySelector("#closeDlg").onclick = ()=> dlg.close();

/* ======== PIN HANDLERS ======== */
dlg.querySelector("#pinSubmit").onclick = async (e)=>{
  e.preventDefault();
  const entered = dlg.querySelector("#pinInput").value.trim();
  const stored = await fetchPin();
  if(validPin(stored) && entered===stored){
    dlg.close();
    openTeacherPanel();
  } else alert("Invalid PIN.");
};
dlg.querySelector("#pinSet").onclick = async (e)=>{
  e.preventDefault();
  const p = dlg.querySelector("#pinInput").value.trim();
  if(!validPin(p)){alert("Enter 4 digits.");return;}
  await savePin(p);
  alert("PIN saved for this class.");
};

/* ======== TEACHER PANEL ======== */
const teacherPanel = document.createElement("dialog");
teacherPanel.id="teacherPanel";
teacherPanel.innerHTML = `
  <div style="padding:18px;max-width:720px">
    <h3>Teacher Portal</h3>
    <p class="mut tiny">Live class monitoring, prompt setup, and score export.</p>
    <div class="flex" style="gap:8px;margin-top:8px">
      <input id="classNameInput" placeholder="Class name" style="flex:1;padding:.4rem;border:1px solid #ccc;border-radius:8px">
      <button id="setClass" class="btn">Set Class</button>
      <button id="closeTeacher" class="btn-ghost">Close</button>
    </div>
    <div id="tpInfo" style="margin-top:10px" class="mut tiny"></div>
    <hr style="margin:10px 0;">
    <div id="studentList" style="max-height:260px;overflow:auto;font-size:.9rem"></div>
    <hr style="margin:10px 0;">
    <div class="flex" style="gap:8px;flex-wrap:wrap">
      <button id="softReset" class="btn-ghost">Soft Reset</button>
      <button id="newSession" class="btn-ghost">New Session</button>
      <button id="exportCSV" class="btn-ghost">Export CSV</button>
    </div>
  </div>`;
document.body.appendChild(teacherPanel);
teacherPanel.querySelector("#closeTeacher").onclick=()=>teacherPanel.close();
function openTeacherPanel(){ teacherPanel.showModal(); }

/* ======== CLASS CONTROLS ======== */
teacherPanel.querySelector("#setClass").onclick = async ()=>{
  const k = teacherPanel.querySelector("#classNameInput").value.trim();
  if(!k){alert("Enter a class name.");return;}
  await setClassKey(k);
  teacherPanel.querySelector("#tpInfo").textContent = "Class set to "+live.classKey;
  fb.db.ref(DBPATH("sessions/current")).set(Date.now());
};

/* ======== LIVE STUDENT TRACKING ======== */
let rosterRef=null;
function attachRoster(){
  if(rosterRef) rosterRef.off();
  rosterRef = fb.db.ref(DBPATH("students"));
  rosterRef.on("value", snap=>{
    const data=snap.val()||{};
    const box=teacherPanel.querySelector("#studentList");
    box.innerHTML="";
    Object.entries(data).forEach(([id,s])=>{
      const d=document.createElement("div");
      d.textContent=`${s.name||"Student"} — ${s.score||0} pts`;
      box.appendChild(d);
    });
  });
}
teacherPanel.querySelector("#softReset").onclick = ()=>fb.db.ref(DBPATH("control/softReset")).set(Date.now());
teacherPanel.querySelector("#newSession").onclick = ()=>fb.db.ref(DBPATH("control/newSession")).set(Date.now());

/* ======== EXPORT CSV ======== */
teacherPanel.querySelector("#exportCSV").onclick = async ()=>{
  const snap=await fb.db.ref(DBPATH("students")).get();
  const rows=[["Name","Score"]];
  const data=snap.val()||{};
  Object.values(data).forEach(s=>rows.push([s.name||"—",s.score||0]));
  const csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download=`ec-scores-${live.classKey}.csv`;a.click();
  URL.revokeObjectURL(url);
};

/* ======== STUDENT SCORING ======== */
function updateScore(points){
  if(!fb.db||!live.classKey)return;
  const uid=localStorage.getItem("ec_uid")||Math.random().toString(36).slice(2);
  localStorage.setItem("ec_uid",uid);
  const name=localStorage.getItem("ec_name")||"Student";
  fb.db.ref(DBPATH(`students/${uid}`)).update({name,score:points});
}
function deductPoint(){
  let cur=Number($("#trayCount").textContent)||0;
  if(cur>0){cur--;$("#trayCount").textContent=cur;updateScore(cur);}
}

/* ======== INIT FIREBASE ON LOAD ======== */
window.addEventListener("load",()=>{ try{initFirebase();}catch(e){console.error(e);} });
/* ======== INTEGRATION WITH EXISTING CHECK LOGIC ======== */
let score=0;
function awardPoint(){
  score++;
  updateScore(score);
}
function losePoint(){
  if(score>0)score--;
  updateScore(score);
}

/* ======== EXTEND CHECK BUTTON ======== */
const oldCheck = checkAnswer;
checkAnswer = function(){
  if(currentElectrons===expectedElectrons){
    awardPoint();
    alert("✅ Correct! 1 point awarded.");
  }else if(currentElectrons>expectedElectrons){
    losePoint();
    alert("⚠️ Too many electrons. Point deducted.");
  }else{
    alert("Incomplete — add remaining electrons.");
  }
  updateScore(score);
};

/* ======== TEACHER-PUSHED TEST LIST ======== */
const promptBox=document.createElement("div");
promptBox.id="promptBox";
promptBox.style.cssText="position:fixed;bottom:10px;left:10px;background:#fff;border:1px solid #ccc;border-radius:10px;padding:10px;font-size:.9rem;z-index:1000";
promptBox.innerHTML=`<div><strong>Current Prompt:</strong> <span id="currentPrompt">None</span></div>`;
document.body.appendChild(promptBox);

async function listenForPrompts(){
  if(!fb.db)return;
  const ref=fb.db.ref(DBPATH("currentPrompt"));
  ref.on("value",snap=>{
    const val=snap.val();
    if(!val)return;
    $("#currentPrompt").textContent=val.symbol;
    if(val.symbol){
      setElement(val.symbol);
      clearGrid();
    }
  });
}
listenForPrompts();

/* ======== TEACHER — SEND PROMPTS ======== */
const tpSend=document.createElement("div");
tpSend.innerHTML=`
  <div style="margin-top:10px">
    <input id="tpElement" placeholder="Element (e.g. Fe)" style="width:5rem;padding:.3rem;border:1px solid #ccc;border-radius:8px">
    <label><input type="checkbox" id="tpIon"> Ion</label>
    <label><input type="checkbox" id="tpNoble"> Noble Gas Config</label>
    <button id="sendPromptBtn" class="btn-ghost">Send</button>
  </div>`;
teacherPanel.querySelector("div").appendChild(tpSend);

teacherPanel.querySelector("#sendPromptBtn").onclick=async()=>{
  const el=teacherPanel.querySelector("#tpElement").value.trim();
  const ion=teacherPanel.querySelector("#tpIon").checked;
  const noble=teacherPanel.querySelector("#tpNoble").checked;
  if(!el){alert("Enter an element.");return;}
  const data={symbol:el,ion,noble,ts:Date.now()};
  await fb.db.ref(DBPATH("currentPrompt")).set(data);
  alert("Prompt sent to class.");
};

/* ======== NOBLE GAS AUTOFILL ======== */
function autoFillNoble(sym){
  const noble={He:2,Ne:10,Ar:18,Kr:36,Xe:54,Rn:86};
  const keys=Object.keys(noble);
  let prev=null;
  for(const k of keys){
    if(noble[k]<expectedElectrons)prev=k;else break;
  }
  if(prev){
    const val=noble[prev];
    for(let i=0;i<val;i++){
      const id=`e${Date.now()}${i}`;
      const e=createElectron(id);
      $("#orbitalGrid").appendChild(e);
    }
    updateElectronCount();
  }
}

/* ======== STUDENT RECEIVE NOBLE PROMPT ======== */
fb.db.ref(DBPATH("currentPrompt")).on("value",snap=>{
  const p=snap.val();
  if(!p)return;
  if(p.noble){
    setTimeout(()=>autoFillNoble(p.symbol),400);
  }
});

/* ======== CLASS CLOSE CONTROL ======== */
teacherPanel.querySelector("#newSession").insertAdjacentHTML("afterend",
  `<button id="closeClass" class="btn-ghost">Close Class</button>`);
teacherPanel.querySelector("#closeClass").onclick=async()=>{
  if(confirm("Close this class and remove all students?")){
    await fb.db.ref(DBPATH("students")).set(null);
    alert("Class closed and cleared.");
  }
};

/* ======== PERIODIC TABLE IN SHOW ANSWERS ======== */
const ansWrap=document.querySelector("#answerBox");
const tblWrap=document.createElement("div");
tblWrap.id="ptableWrap";
tblWrap.style.cssText="margin-top:8px;border-top:1px solid #ccc;padding-top:8px";
tblWrap.innerHTML=`<h4 style="margin:4px 0">Periodic Table View</h4><div id="ptable" class="ptable"></div>`;
ansWrap.appendChild(tblWrap);
renderTable();

/* ======== INIT FIREBASE-STUDENT LINK ======== */
window.addEventListener("load",()=>{
  try{
    const nm=localStorage.getItem("ec_name")||prompt("Enter your name for score tracking:","Student");
    if(nm)localStorage.setItem("ec_name",nm);
    attachRoster();
  }catch(e){console.error(e);}
});
/* ======== FINAL WRAPUP ======== */
console.log("Electron-Config + Teacher Portal initialized successfully.");
</script>

<!-- ======== STYLES (OPTIONAL COLOR KEYS) ======== -->
<style>
  .ptable {
    display:grid;
    grid-template-columns: repeat(18,1fr);
    gap:2px;
    font-size:10px;
  }
  .ptcell {
    text-align:center;
    border:1px solid #ccc;
    border-radius:3px;
    padding:2px;
    line-height:1.1;
  }
  .ptcell.s { background:#d4eaff; }
  .ptcell.p { background:#ffd9d9; }
  .ptcell.d { background:#fff0c2; }
  .ptcell.f { background:#d6f7d6; }
  #tpBtnTeacher {
    position:fixed;
    bottom:20px;
    right:20px;
    background:#111;
    color:#fff;
    font-weight:700;
    border-radius:50%;
    width:42px;
    height:42px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    z-index:2000;
  }
</style>

<!-- floating teacher-portal trigger -->
<div id="tpBtnTeacher" title="Teacher Portal">T</div>

</body>
</html>
