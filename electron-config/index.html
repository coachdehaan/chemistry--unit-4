<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Electron Configuration — Class/Test Mode</title>
<style>
  :root{
    --bg:#0f1216; --fg:#e6eaf0; --mut:#a8b0bd; --accent:#5aa7ff;
    --s:#0e6b73; --p:#4b5f16; --d:#5c1135; --f:#143ea9;
    --boxB:#5a6b86; --ok:#22c55e; --orb:#0f1622;
    --panel:#0b111b; --edge:#273244; --chip:#0f1622;
    --overlay:rgba(2,8,23,.55); --warn:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Arial,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:16px}
  h1{font-size:18px;margin:0 0 10px}
  .panel{border:1px solid var(--edge);border-radius:12px;background:var(--panel)}
  .panel .inner{padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{border:1px solid #2b3a55;border-radius:10px;padding:4px 8px;background:var(--chip);color:#dce6f4}
  .cfg{background:#111a27;border:1px solid #2b3a55;border-radius:8px;padding:6px 8px}
  .hint{font-size:12px;color:var(--mut)}
  .hidden{display:none}

  .hdr{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
  .hdr input{padding:.3rem .5rem;border:1px solid #2b3a55;border-radius:8px;background:#0e1726;color:#dbe7ff}
  .tiny{font-size:11px;color:#aab8d0}

  .promptbar{display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--edge);
    background:#0b121d;padding:8px 12px;border-bottom:1px solid var(--edge)}
  .pill{border:1px solid #2b3a55;background:#0e1726;color:#dbe7ff;border-radius:9999px;padding:.15rem .55rem;font-size:12px}
  .prompt{font-weight:600}
  .score{font-weight:700}

  .blocks{display:grid;grid-template-columns:auto 1fr 1fr 1fr 1fr;gap:14px;align-items:start}
  .blabel{display:flex;align-items:center;gap:10px}
  .bl{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
  .sbg{background:var(--s)} .pbg{background:var(--p)} .dbg{background:var(--d)} .fbg{background:var(--f)}
  .block{display:grid;gap:8px}
  .rowline{display:flex;align-items:center;gap:10px}
  .rlabel{width:28px;text-align:right;opacity:.85}
  .orbitals{display:flex;gap:8px}
  .orbital{width:42px;height:34px;border:2px solid var(--boxB);border-radius:8px;background:var(--orb);display:flex;align-items:center;justify-content:center}
  .orbital.full{border-color:var(--ok)}
  .orbital.over{outline:2px dashed var(--accent)}

  .e{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;user-select:none}
  .up{background:#1f6d3a;border:1px solid #3dd17b;color:#c6f7da}
  .down{background:#7a2c21;border:1px solid #ff9c8a;color:#ffeae7}

  /* TRAY NOW EMBEDDED (not fixed) */
  .float-tray{
    position: static;
    z-index: 1;
    margin-top: 10px;
    backdrop-filter:saturate(1.2) blur(6px);
    background:rgba(16,22,33,0.86);
    border:1px solid #2b3a55; border-radius:14px;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
    padding:10px 12px; color:#dbe7ff
  }
  .float-tray .top{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
  .float-tray .arrows{display:flex;gap:8px}
  .float-tray .e{cursor:grab}

  /* Teacher Panel */
  #teacherPanel{margin-top:16px}
  .tp-wrap{display:grid;grid-template-columns: 1.2fr 1fr; gap:16px}
  @media (max-width:1000px){ .tp-wrap{grid-template-columns:1fr} }
  .pt-grid{display:grid;grid-template-columns: repeat(18, 32px); gap:4px; align-items:start}
  .pt-btn{
    width:32px;height:32px;border-radius:6px;border:1px solid #2b3a55;background:#0e1726;
    color:#dbe7ff;font-size:12px;display:flex;align-items:center;justify-content:center;cursor:pointer
  }
  .pt-btn:hover{outline:2px solid #3a82ff}
  .pt-blank{visibility:hidden}
  .queue{display:flex;flex-direction:column;gap:8px}
  .queue-item{display:flex;align-items:center;gap:8px;border:1px solid #2b3a55;border-radius:10px;padding:6px 8px;background:#0e1726;flex-wrap:wrap}
  .chip{padding:.1rem .45rem;border:1px solid #2b3a55;border-radius:999px;background:#132034}

  /* Totals text */
  #classTotals strong{font-weight:700}
</style>

<!-- Firebase compat -->
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="inner">
      <div class="hdr">
        <div class="row" style="gap:8px">
          <h1>Electron Configuration — Class/Test Mode</h1>
          <span id="connectionBadge" class="badge">offline (local)</span>
          <span class="tiny">Class: <strong id="classLabel">—</strong></span>
          <span class="tiny">Session: <strong id="sessionLabel">—</strong></span>
        </div>
        <div class="row" style="gap:8px">
          <input id="classInput" class="tiny" style="width:9rem" placeholder="CLASS">
          <button id="setClassBtn" class="btn">Set Class</button>
          <button id="shareClassBtn" class="btn">Copy Link</button>
          <input id="nameInput" class="tiny" style="width:9rem" placeholder="Your name">
          <button id="saveNameBtn" class="btn">Save Name</button>
          <button id="loginBtn" class="btn">Teacher Login</button>
          <label class="hint"><input id="nobleToggle" type="checkbox" checked> Noble-gas shorthand ≥ Period 4</label>
          <button id="toggleAnswers" class="btn">Show Answers</button>
        </div>
      </div>

      <!-- Answers -->
      <div id="answersPanel" class="hidden" aria-live="polite">
        <div class="row" style="margin-top:6px;">
          <div class="badge">Z = <strong id="Z">0</strong></div>
          <div class="badge">Element: <strong id="El">—</strong></div>
          <div class="badge">Period: <strong id="Period">—</strong></div>
        </div>
        <div style="margin-top:8px;">
          <div>Full configuration:</div>
          <div id="cfg" class="cfg">—</div>
          <div class="hint" style="margin-top:4px;">Shorthand: <span id="sh" class="cfg">—</span></div>
        </div>
        <div style="margin-top:8px;">
          <div>Quantum numbers (last e⁻):</div>
          <div id="qn" class="cfg">n = —, ℓ = — (—), m<sub>ℓ</sub> = —, m<sub>s</sub> = —</div>
        </div>
      </div>
    </div>

    <!-- Prompt + score -->
    <div class="promptbar">
      <div>
        <span class="pill" id="modeBadge">practice</span>
        <span class="prompt" id="promptText">—</span>
      </div>
      <div class="tiny">
        Item: <span id="itemIdx">—</span> /
        <span id="itemTotal">—</span> •
        Points: <span class="score" id="scoreNow">—</span>
      </div>
    </div>

    <!-- Student QN entry (test mode only) -->
    <div class="inner" id="studentTestBar" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <div class="hint">Enter quantum numbers (last e⁻):</div>
          <input id="qn_n" type="number" min="1" max="7" step="1" placeholder="n">
          <select id="qn_l">
            <option value="">ℓ</option><option value="0">0 (s)</option><option value="1">1 (p)</option><option value="2">2 (d)</option><option value="3">3 (f)</option>
          </select>
          <input id="qn_ml" type="number" step="1" placeholder="mℓ">
          <select id="qn_ms"><option value="">mₛ</option><option value="+1/2">+1/2</option><option value="-1/2">-1/2</option></select>
        </div>
        <div class="row">
          <button id="submitBtn" class="btn primary">Submit Answer</button>
        </div>
      </div>
      <div class="hint" id="qnHint">QN may be required depending on teacher prompt.</div>
    </div>

    <!-- Workspace -->
    <div class="inner">
      <div class="blocks" id="blocks">
        <div></div>
        <div class="blabel"><div class="bl sbg">s</div><div class="hint">block</div></div>
        <div class="blabel"><div class="bl pbg">p</div><div class="hint">block</div></div>
        <div class="blabel"><div class="bl dbg">d</div><div class="hint">block</div></div>
        <div class="blabel"><div class="bl fbg">f</div><div class="hint">block</div></div>

        <div id="labels" class="block"></div>
        <div id="scol" class="block"></div>
        <div id="pcol" class="block"></div>
        <div id="dcol" class="block"></div>

        <!-- NEW: tray anchor directly after d-column (parks under 3d row area) -->
        <div id="trayHolder"></div>

        <div id="fcol" class="block"></div>
      </div>
    </div>

    <!-- Embedded Teacher Panel -->
    <div id="teacherPanel" class="inner hidden">
      <h3 style="margin:0 0 8px 0">Teacher Panel</h3>
      <div class="tp-wrap">
        <!-- Periodic chart & queue builder -->
        <div class="panel">
          <div class="inner">
            <div class="row" style="justify-content:space-between;align-items:center">
              <h4 style="margin:0">Periodic Chart → Queue</h4>
              <div class="row">
                <label class="tiny">Points per item: <input id="tp_points" type="number" min="1" max="20" value="5" style="width:64px"></label>
                <label class="tiny"><input id="tp_requireQN" type="checkbox"> Require QN</label>
                <button id="tp_clearQueue" class="btn">Clear Queue</button>
              </div>
            </div>
            <div id="pt" class="pt-grid" style="margin-top:10px"></div>
            <div class="hint" style="margin-top:6px">Click elements to add to the test list. Adjust charge (±) and toggle NG (start from noble gas core).</div>
          </div>
        </div>

        <!-- Queue, send, roster -->
        <div class="panel">
          <div class="inner">
            <h4 style="margin:0 0 8px 0">Test List</h4>
            <div id="queue" class="queue"></div>
            <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
              <button id="tp_sendList" class="btn primary">Send Test (<span id="qCount">0</span> items)</button>
              <button id="tp_softReset" class="btn">Soft Reset Boards</button>
              <button id="tp_newSession" class="btn warn">New Session</button>
              <button id="exportBtn" class="btn">Export Scores CSV</button>
            </div>

            <!-- CLASS TOTALS BAR -->
            <div id="classTotals" class="hint" style="margin:6px 0 8px 0"></div>

            <h4 style="margin:12px 0 8px 0">Live Roster & Scores</h4>
            <div style="max-height:260px;overflow:auto;border:1px solid #2b3a55;border-radius:12px">
              <table id="scoreTable">
                <thead>
                  <tr>
                    <th style="width:30%">Student</th>
                    <th style="width:14%">Right / Total</th>
                    <th style="width:14%">Points</th>
                    <th style="width:22%">Last Submit</th>
                    <th style="width:20%">ID</th>
                  </tr>
                </thead>
                <tbody id="scoreBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div><!-- /tp-wrap -->
    </div><!-- /teacherPanel -->

  </div>
</div>

<!-- NOTE: no fixed-bottom tray block anymore; tray is injected under 3d via JS -->

<!-- PIN dialog -->
<dialog id="loginDlg" style="border:none;border-radius:12px;max-width:420px;width:92%">
  <form method="dialog" style="padding:16px">
    <h3 style="margin:0 0 8px 0">Teacher Login</h3>
    <p class="tiny" style="margin-top:0">Enter PIN to unlock Teacher Panel.</p>
    <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4"
           style="width:100%;padding:.6rem;border:1px solid #2b3a55;border-radius:10px;background:#0e1726;color:#dbe7ff" placeholder="4-digit PIN">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="unlockBtn" class="btn" value="unlock">Unlock</button>
      <button class="btn" value="cancel">Close</button>
    </div>
    <div id="pinSetup" class="tiny" style="margin-top:8px;display:none">
      No PIN set for this class. Create one now:
      <div style="display:flex;gap:8px;margin-top:6px">
        <input id="newPinInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4"
               style="flex:1;padding:.5rem;border:1px solid #2b3a55;border-radius:8px;background:#0e1726;color:#dbe7ff" placeholder="New 4-digit PIN">
        <button id="saveNewPinBtn" class="btn" type="button">Save PIN</button>
      </div>
    </div>
  </form>
</dialog>

<script>
/* ===== Error guard ===== */
window.onunhandledrejection = e => console.error(e.reason||e);

/* ===== Firebase core ===== */
const CONFIG = {
  useFirebase: true,
  firebaseConfig: {
    apiKey: "AIzaSyAal8uHe9nePGimXiRPZAnBl0ucQlKnXNo",
    authDomain: "presentation-83d1f.firebaseapp.com",
    databaseURL: "https://presentation-83d1f-default-rtdb.firebaseio.com",
    projectId: "presentation-83d1f",
    storageBucket: "presentation-83d1f.firebasestorage.app",
    messagingSenderId: "132406143951",
    appId: "1:132406143951:web:9695690023bd3f2aedc0ba"
  }
};

const $ = s=>document.querySelector(s);
function sanitizeClassName(s){ return (s||'').trim().toUpperCase().replace(/[^A-Z0-9-]/g,'-').replace(/-+/g,'-').slice(0,32) || 'CLASS'; }
function getUrlParam(name){ try { return new URL(location.href).searchParams.get(name); } catch { return null; } }
function setUrlParam(name, value){
  try{ const u=new URL(location.href); if(value==null) u.searchParams.delete(name); else u.searchParams.set(name,value); history.replaceState({}, "", u.toString()); }catch{}
}
function uid(){ return Math.random().toString(36).slice(2,9); }
function nowId(){ return String(Date.now()); }
function badge(txt){ const b=$('#connectionBadge'); if(b) b.textContent = txt; }
function fmtTime(t){ if(!t) return '—'; const d=new Date(t); return d.toLocaleString(); }

const fb = { db:null, online:false };
const live = { classKey:null, sessionId:null, me:{id:null,name:null}, classHasPin:false };
const paths = {
  classPath: () => `/classes/${live.classKey}`,
  configPath: () => `${paths.classPath()}/config`,
  sessRoot:   () => `${paths.classPath()}/sessions`,
  basePath:   () => `${paths.sessRoot()}/${live.sessionId}`,
  prompts:    () => `${paths.basePath()}/prompts`,
  currentPrompt: () => `${paths.prompts()}/current`,
  results:    () => `${paths.basePath()}/results`,
  students:   () => `${paths.basePath()}/students`,
  control:    () => `${paths.basePath()}/control`,
  progressRoot: () => `${paths.basePath()}/progress`  // per-student index into current list
};

async function dbInit(){
  if(!CONFIG.useFirebase){ badge('offline (local)'); return; }
  try{
    if (firebase.apps && firebase.apps.length === 0) firebase.initializeApp(CONFIG.firebaseConfig);
    fb.db = firebase.database();
    await firebase.auth().signInAnonymously();
    fb.online = true; badge('online (firebase)');
    await bootFromClass();
  }catch(e){ console.error(e); fb.online=false; badge('offline (local)'); }
}

async function bootFromClass(){
  const urlC = getUrlParam('class');
  const savedC = localStorage.getItem('ec_class');
  setClassKey(sanitizeClassName(urlC || savedC || 'CLASS'), false);
  $('#classInput').value = live.classKey; $('#classLabel').textContent = live.classKey;

  const cfgSnap = await fb.db.ref(paths.configPath()).get();
  const cfg = cfgSnap.val() || {};
  live.classHasPin = typeof cfg.teacherPin === 'string' && cfg.teacherPin.length === 4;

  let s = (await fb.db.ref(`${paths.configPath()}/currentSession`).get()).val();
  if(!s){ s = nowId(); await fb.db.ref(`${paths.configPath()}/currentSession`).set(s); }
  live.sessionId = s; $('#sessionLabel').textContent = s.slice(-6);

  ensureStudentPresence();
  attachPromptListener();
  attachResetListeners();
  subscribeRoster();
  subscribeScores();
}

function setClassKey(k, writeUrl=true){
  live.classKey = sanitizeClassName(k);
  localStorage.setItem('ec_class', live.classKey);
  if(writeUrl) setUrlParam('class', live.classKey);
}
function ensureStudentPresence(){
  let id = localStorage.getItem('ec_uid');
  if(!id){ id = uid(); localStorage.setItem('ec_uid', id); }
  live.me.id = id;

  const nm = localStorage.getItem('ec_name') || '';
  live.me.name = nm || null;
  if(nm) $('#nameInput').value = nm;

  const ref = fb.db.ref(`${paths.students()}/${id}`);
  ref.set({ name: nm || null, at: firebase.database.ServerValue.TIMESTAMP }).catch(()=>{});
  try{ ref.onDisconnect().remove(); }catch{}
}
$('#saveNameBtn').onclick = ()=>{
  const nm = ($('#nameInput').value||'').trim().slice(0,40);
  localStorage.setItem('ec_name', nm);
  live.me.name = nm || null;
  if(fb.db) fb.db.ref(`${paths.students()}/${live.me.id}`).update({ name: nm || null, at: firebase.database.ServerValue.TIMESTAMP }).catch(()=>{});
  alert('Name saved.');
};

/* PIN */
async function fetchPin(){
  const cfg = (await fb.db.ref(paths.configPath()).get()).val() || {};
  live.classHasPin = typeof cfg.teacherPin === 'string' && cfg.teacherPin.length === 4;
  return cfg.teacherPin || null;
}
async function savePin(pin){ await fb.db.ref(paths.configPath()).update({ teacherPin: pin }); live.classHasPin = true; }
function validPin(p){ return /^\d{4}$/.test(p || ''); }

/* Reset listeners */
function tokenSeenKey(kind){ return `ec_seen_${live.classKey}_${kind}_${live.sessionId||'none'}`; }
function getSeen(kind){ return Number(localStorage.getItem(tokenSeenKey(kind)) || 0); }
function setSeen(kind,v){ localStorage.setItem(tokenSeenKey(kind), String(v)); }
function attachResetListeners(){
  const softRef = fb.db.ref(`${paths.control()}/softResetAt`);
  const hardRef = fb.db.ref(`${paths.control()}/resetAt`);
  softRef.on('value', s=>{
    const t = Number(s.val()||0);
    if(t && t>getSeen('soft')){ setSeen('soft',t); resetBoard(); }
  });
  hardRef.on('value', async s=>{
    const t = Number(s.val()||0);
    if(t && t>getSeen('hard')){
      setSeen('hard',t);
      let next = nowId();
      await fb.db.ref(`${paths.configPath()}/currentSession`).set(next);
      live.sessionId = next; $('#sessionLabel').textContent = next.slice(-6);
      resetBoard();
      attachPromptListener(); subscribeRoster(true); subscribeScores(true);
    }
  });
}

/* =========================
   Student/Test engine + list
   ========================= */
const ORDER = ["1s","2s","2p","3s","3p","4s","3d","4p","5s","4d","5p","6s","4f","5d","6p","7s","5f","6d","7p"];
const ORB_COUNT = { s:1, p:3, d:5, f:7 };
const CAP       = { s:2, p:6, d:10, f:14 };

const SYMBOLS=[null,"H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar",
"K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr",
"Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe",
"Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu",
"Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn",
"Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr",
"Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"];
const PERIOD =(()=>{const b=[2,10,18,36,54,86,118]; const p=[null]; for(let z=1,k=1; z<=118; z++){ if(z>b[k-1]) k++; p[z]=k; } return p;})();
const NOBLES=[{Z:2,sym:"He"},{Z:10,sym:"Ne"},{Z:18,sym:"Ar"},{Z:36,sym:"Kr"},{Z:54,sym:"Xe"},{Z:86,sym:"Rn"},{Z:118,sym:"Og"}];

const state = { orbitals:{}, Z:0, history:[], lastQN:null };
const test = {
  mode:'practice',
  requireQN:false,
  pointsPer:5,
  list:null,              // array of {Z, charge, ng:boolean}
  idx:0,                  // current item index (per student progress)
  score:null
};

/* Build orbital grid (s, p, d, f columns) */
function addRow(container, tag, boxes){
  const line=document.createElement('div'); line.className='rowline';
  const lab=document.createElement('div'); lab.className='rlabel'; lab.textContent=tag;
  const wrap=document.createElement('div'); wrap.className='orbitals';
  for(let i=0;i<boxes;i++){
    const box=document.createElement('div');
    box.className='orbital';
    box.dataset.key=`${tag}:${i}`;
    box.dataset.sub=tag.replace(/[0-9]/g,"");
    box.dataset.idx=String(i);
    box.addEventListener('dragover', ev=>{ ev.preventDefault(); box.classList.add('over'); });
    box.addEventListener('dragleave', ()=> box.classList.remove('over'));
    box.addEventListener('drop', ev=>{
      ev.preventDefault(); box.classList.remove('over');
      const spin=ev.dataTransfer.getData('text/plain')||ev.dataTransfer.getData('text');
      attemptPlace(box, spin, true);
    });
    wrap.appendChild(box);
    state.orbitals[`${tag}:${i}`]=[];
  }
  line.appendChild(lab); line.appendChild(wrap);
  container.appendChild(line);
}
function buildBlocks(){
  const scol=$('#scol'), pcol=$('#pcol'), dcol=$('#dcol'), fcol=$('#fcol');
  scol.innerHTML=pcol.innerHTML=dcol.innerHTML=fcol.innerHTML="";
  const sTags=["1s","2s","3s","4s","5s","6s","7s"];
  const pTags=["2p","3p","4p","5p","6p","7p"];
  const dTags=["3d","4d","5d","6d"];
  const fTags=["4f","5f"];
  [...sTags].reverse().forEach(tag=> addRow(scol, tag, 1));
  [...pTags].reverse().forEach(tag=> addRow(pcol, tag, 3));
  [...dTags].reverse().forEach(tag=> addRow(dcol, tag, 5));
  [...fTags].reverse().forEach(tag=> addRow(fcol, tag, 7));
}

/* Build and place tray under 3d */
function buildTrayHTML(){
  const wrap = document.createElement('div');
  wrap.className = 'float-tray';
  wrap.innerHTML = `
    <div class="top">
      <div class="arrows" title="Drag an electron into the next allowed orbital">
        <div class="e up" draggable="true" data-spin="up">↑</div>
        <div class="e down" draggable="true" data-spin="down">↓</div>
      </div>
      <button id="autoOne" class="btn primary" title="Place next allowed electron">Auto-place 1</button>
      <button id="autoRemove" class="btn warn" title="Undo last correct placement">Auto-remove 1</button>
      <button id="clear" class="btn">Clear</button>
    </div>
  `;
  return wrap;
}
function placeTrayUnder3d(){
  const holder = document.getElementById('trayHolder');
  if(!holder) return;
  const tray = buildTrayHTML();
  holder.innerHTML = '';
  holder.appendChild(tray);

  // wire drag sources
  holder.querySelectorAll('.float-tray .e').forEach(el=>{
    el.addEventListener('dragstart', ev=>{
      ev.dataTransfer.setData('text/plain', el.dataset.spin);
    });
  });
  // wire buttons (respecting test/practice guards)
  document.getElementById('autoOne').onclick = ()=>{
    if(test.mode==='test') return;
    const a=nextAllowed(); if(!a) return;
    const box=document.querySelector(`.orbital[data-key="${a.key}"]`);
    attemptPlace(box, a.spin, false);
  };
  document.getElementById('autoRemove').onclick = ()=>{
    if(test.mode==='test') return;
    if(!state.history.length) return;
    const last=state.history.pop(); const occ=state.orbitals[last.key];
    if(occ && occ.length){
      occ.pop();
      const box=document.querySelector(`.orbital[data-key="${last.key}"]`);
      if(box) drawOrbital(box, occ);
      if(state.Z>0) state.Z--;
      state.lastQN=null; syncReadouts(); syncQuantumLast();
    }
  };
  document.getElementById('clear').onclick = ()=>{
    if(test.mode==='test') return;
    resetBoard();
  };
}

/* drag sources inside tray are wired in placeTrayUnder3d() */

/* counters & order */
function counters(){ const c={}; for(const tag of ORDER){ const sub=tag.replace(/[0-9]/g,""); const cnt=ORB_COUNT[sub]; let sum=0; for(let i=0;i<cnt;i++) sum+=state.orbitals[`${tag}:${i}`]?.length||0; c[tag]=sum; } return c; }
function currentSubshell(){ const c=counters(); for(const tag of ORDER){ const sub=tag.replace(/[0-9]/g,""); if(c[tag] < CAP[sub]) return tag; } return null; }
function nextAllowed(){
  const tag=currentSubshell(); if(!tag) return null;
  const sub=tag.replace(/[0-9]/g,""); const count=ORB_COUNT[sub];
  const keys=[...Array(count).keys()].map(i=>`${tag}:${i}`);
  const occs=keys.map(k=>state.orbitals[k]);
  for(let i=0;i<count;i++){ if((occs[i]||[]).length===0) return {key:keys[i], spin:'up', tag}; }
  for(let i=0;i<count;i++){ if((occs[i]||[]).length===1 && !occs[i].some(e=>e.spin==='down')) return {key:keys[i], spin:'down', tag}; }
  for(let i=0;i<count;i++){ if((occs[i]||[]).length===1) return {key:keys[i], spin:(occs[i][0].spin==='up'?'down':'up'), tag}; }
  return null;
}

/* QN helpers */
const L_FROM_SUB={s:0,p:1,d:2,f:3};
function mlSeq(sub){ const l=L_FROM_SUB[sub]; const a=[]; for(let m=-l;m<=l;m++) a.push(m); return a; }
function qnFromKeySpin(key,spin){
  const tag=key.split(":")[0], n=parseInt(tag), sub=tag.replace(/[0-9]/g,""), l=L_FROM_SUB[sub];
  const idx=parseInt(key.split(":")[1],10), mlList=mlSeq(sub), m_l=mlList[idx] ?? 0, m_s=(spin==='up')?'+1/2':'-1/2';
  return {n,l,sub,m_l,m_s};
}

/* Noble helpers & configs */
function nearestNobleCore(z){ let core=null; for(const ng of NOBLES){ if(ng.Z<=z) core=ng; else break; } return core; }
function buildCountsForZ(z){ const counts={}; for(const tag of ORDER) counts[tag]=0; let left=z; for(const tag of ORDER){ if(left<=0) break; const sub=tag.replace(/[0-9]/g,""); const take=Math.min(CAP[sub],left); counts[tag]=take; left-=take; } return counts; }
function prefillToZ(z){
  // Clear
  for(const k in state.orbitals) state.orbitals[k]=[];
  document.querySelectorAll('.orbital').forEach(b=>{ b.innerHTML=''; b.classList.remove('full'); });

  // Fill up to Z deterministically by allowed order
  let toPlace = z;
  while(toPlace>0){
    const a = nextAllowed();
    if(!a) break;
    const box = document.querySelector(`.orbital[data-key="${a.key}"]`);
    state.orbitals[a.key].push({spin:a.spin});
    drawOrbital(box, state.orbitals[a.key]);
    state.Z++;
    toPlace--;
  }
  state.history=[]; state.lastQN=null; syncReadouts(); syncQuantumLast();
}

/* apply prompt (supports single or list) */
let unsubPrompt=null, unsubMyProgress=null;
function attachPromptListener(){
  if(!fb.db) return;
  const ref = fb.db.ref(paths.currentPrompt());
  if(unsubPrompt) try{ ref.off(); }catch{}
  ref.on('value', snap=>{
    const v = snap.val() || null;
    applyPrompt(v);
  });
  unsubPrompt = ref;
}
function speciesTargetZ(goal){
  if(!goal) return null;
  if(goal.kind==='element') return goal.Z;
  if(goal.kind==='ion') return goal.Z - (goal.charge||0);
  return null;
}
function applyPrompt(v){
  if(!v){ setPractice(); return; }
  test.mode = 'test';
  test.requireQN = !!v.requireQN;
  test.pointsPer = Number(v.pointsPer)||5;

  if (Array.isArray(v.list) && v.list.length){
    test.list = v.list.slice();
    document.getElementById('itemTotal').textContent = test.list.length;
    if(unsubMyProgress) try{ fb.db.ref(`${paths.progressRoot()}/${live.me.id}`).off(); }catch{}
    const myRef = fb.db.ref(`${paths.progressRoot()}/${live.me.id}`);
    myRef.on('value', snap=>{
      let idx = Number(snap.val()||0);
      if(!Number.isInteger(idx) || idx<0) idx=0;
      if(idx >= test.list.length) idx = test.list.length;
      test.idx = idx;
      setUpItemFromList();
    });
    unsubMyProgress = myRef;
  } else if (v.goal){
    test.list = [{ Z: v.goal.Z, charge: v.goal.charge||0, ng:false }];
    test.idx = 0;
    document.getElementById('itemTotal').textContent = 1;
    setUpItemFromList();
  }

  document.getElementById('modeBadge').textContent='test';
  document.getElementById('promptText').textContent = labelForCurrent();
  document.getElementById('scoreNow').textContent = test.pointsPer;
  document.getElementById('studentTestBar').style.display = '';
  document.getElementById('qnHint').textContent = test.requireQN ? 'QN are required for credit.' : 'QN not required for this item.';
  document.getElementById('autoOne').disabled=true; document.getElementById('autoRemove').disabled=true; document.getElementById('clear').disabled=true;
}
function setPractice(){
  test.mode='practice'; test.list=null; test.idx=0; test.requireQN=false; test.pointsPer=5; test.score=null;
  document.getElementById('modeBadge').textContent='practice';
  document.getElementById('promptText').textContent='—';
  document.getElementById('scoreNow').textContent='—';
  document.getElementById('studentTestBar').style.display='none';
  document.getElementById('itemIdx').textContent='—'; document.getElementById('itemTotal').textContent='—';
  document.getElementById('autoOne').disabled=false; document.getElementById('autoRemove').disabled=false; document.getElementById('clear').disabled=false;
  resetBoard();
}
function currentItem(){ return (test.list && test.idx<test.list.length) ? test.list[test.idx] : null; }
function labelForItem(it){
  if(!it) return '—';
  const sym = SYMBOLS[it.Z]||'?';
  const ch = it.charge||0;
  const ion = ch===0 ? '' : (ch>0?`^${ch}+`:`^${Math.abs(ch)}-`);
  const ng = it.ng ? ' (NG)' : '';
  return `${sym}${ion}${ng}`;
}
function labelForCurrent(){ return labelForItem(currentItem()); }
function setUpItemFromList(){
  const it = currentItem();
  document.getElementById('itemIdx').textContent = test.list ? String(Math.min(test.idx+1, test.list.length)) : '—';
  document.getElementById('promptText').textContent = labelForItem(it);
  test.score = test.pointsPer;
  document.getElementById('scoreNow').textContent = test.score;
  resetBoard();
  if(!it) return;

  const targetZ = (it.charge && it.charge!==0) ? (it.Z - it.charge) : it.Z;
  if(it.ng){
    const core = nearestNobleCore(targetZ);
    if(core && core.Z>0){ prefillToZ(core.Z); }
  }
}

/* placement + rules + scoring hook */
function attemptPlace(targetBox, spin, userAction){
  const allowed = nextAllowed();
  if(!allowed) return strike("No available orbital","All orbitals through 7p are filled.", userAction);

  const targetKey = targetBox.dataset.key;
  const targetOcc = state.orbitals[targetKey];

  if(targetOcc.length>=2) return strike("Pauli exclusion","That orbital already has two electrons.", userAction);
  if(targetOcc.length===1 && targetOcc[0].spin===spin) return strike("Pauli exclusion","Electrons in the same orbital must have opposite spins.", userAction);

  const curTag = allowed.tag, targetTag = targetKey.split(":")[0];
  if(targetTag !== curTag) return strike("Aufbau order",`Next subshell is <strong>${curTag}</strong>, not <strong>${targetTag}</strong>.`, userAction);

  const sub = curTag.replace(/[0-9]/g,""), count = ORB_COUNT[sub];
  const keys=[...Array(count).keys()].map(i=>`${curTag}:${i}`);
  const anyEmpty = keys.some(k=>state.orbitals[k].length===0);
  if(anyEmpty && targetOcc.length===1) return strike("Hund’s rule","Place one electron (↑) in each orbital of this subshell before pairing (↓).", userAction);

  if(!(targetKey===allowed.key && spin===allowed.spin)){
    if(targetKey===allowed.key && spin!==allowed.spin)
      return strike("Spin / Hund",`Use <strong>${allowed.spin==='up'?'↑':'↓'}</strong> for this step.`, userAction);
    return strike("Order violation",`Place at <strong>${allowed.key.split(':')[0]}</strong> with <strong>${allowed.spin==='up'?'↑':'↓'}</strong>.`, userAction);
  }

  targetOcc.push({spin});
  drawOrbital(targetBox, targetOcc);
  state.Z++;
  state.history.push({ key: targetKey, spin });
  state.lastQN = qnFromKeySpin(targetKey, spin);
  syncReadouts(); syncQuantumLast();

  if(test.mode==='test'){ maybeAutoCheck(); }
}
function drawOrbital(box, occ){
  box.innerHTML='';
  occ.forEach(o=>{ const e=document.createElement('div'); e.className='e '+(o.spin==='up'?'up':'down'); e.textContent=(o.spin==='up'?'↑':'↓'); box.appendChild(e); });
  box.classList.toggle('full', occ.length===2);
}

/* readouts */
function currentConfigCounters(){ const c=counters(), out={}; for(const tag of ORDER){ if(c[tag]>0) out[tag]=c[tag]; } return out; }
function cfgHTML(){ const c=currentConfigCounters(), parts=[]; for(const tag of ORDER){ if(c[tag]) parts.push(`${tag}<sup>${c[tag]}</sup>`);} return parts.length?parts.join(" "):"—"; }
function cfgPlain(){ const c=currentConfigCounters(), parts=[]; for(const tag of ORDER){ if(c[tag]) parts.push(`${tag}${c[tag]}`);} return parts.length?parts.join(" "):"—"; }
function elementSymbol(Z){ return (Z>=1 && Z<=118)? SYMBOLS[Z] : "—"; }
function periodFromZ(Z){ return PERIOD[Z] || "—"; }
function shorthand(){
  const Z=state.Z; if(!Z) return "—";
  const nobleToggle=document.getElementById('nobleToggle').checked; const p=periodFromZ(Z);
  if(!nobleToggle || (typeof p==="number" && p<4)) return cfgPlain();
  let core=null; for(const ng of NOBLES){ if(ng.Z===Z) return `[${ng.sym}]`; if(ng.Z<Z) core=ng; else break; }
  if(!core) return cfgPlain();
  const current=currentConfigCounters(), coreCounts=buildCountsForZ(core.Z);
  const parts=[`[${core.sym}]`];
  for(const tag of ORDER){ const rem=(current[tag]||0)-(coreCounts[tag]||0); if(rem>0) parts.push(`${tag}${rem}`); }
  return parts.join(" ");
}
function syncReadouts(){
  document.getElementById('Z').textContent=state.Z;
  document.getElementById('El').textContent=elementSymbol(state.Z);
  document.getElementById('Period').textContent=periodFromZ(state.Z);
  document.getElementById('cfg').innerHTML=cfgHTML();
  document.getElementById('sh').textContent=shorthand();
}
function syncQuantumLast(){
  const qnEl=document.getElementById('qn');
  if(!state.lastQN){ qnEl.innerHTML='n = —, ℓ = — (—), mℓ = —, ms = —'; return; }
  const q=state.lastQN, lName=({0:'s',1:'p',2:'d',3:'f'})[q.l]||'—';
  qnEl.innerHTML=`n = ${q.n}, ℓ = ${q.l} (${lName}), m<sub>ℓ</sub> = ${q.m_l}, m<sub>s</sub> = ${q.m_s}`;
}

/* warnings */
function warn(title, html){ alert(title + ": " + (html||"")); }
function strike(title, html, userAction){
  if(userAction && test.mode==='test'){ decPoint(); }
  warn(title, html);
  return;
}

/* buttons (tray buttons are rebound after tray insertion) */
document.getElementById('nobleToggle').addEventListener('change', syncReadouts);
const answersPanel=document.getElementById('answersPanel'); const toggleBtn=document.getElementById('toggleAnswers');
toggleBtn.onclick = ()=>{ const hidden=answersPanel.classList.toggle('hidden'); toggleBtn.textContent = hidden?'Show Answers':'Hide Answers'; };

/* scoring */
function decPoint(){ if(test.mode!=='test') return; if(test.score>0){ test.score--; document.getElementById('scoreNow').textContent=test.score; } }

/* auto-check during building (if not requiring QN and exact electron count reached) */
function maybeAutoCheck(){
  const it = currentItem(); if(!it) return;
  const targetZ = speciesTargetZ({kind: it.charge? 'ion':'element', Z: it.Z, charge: it.charge||0});
  if (state.Z < targetZ) return;
  if (state.Z > targetZ){ decPoint(); warn("Too many electrons","You exceeded the target electron count."); return; }
  if(!test.requireQN){
    writeResult(true,'complete_no_qn');
    advanceItem();
  }
}

/* submit (defensive to avoid null lastQN) */
document.getElementById('submitBtn').onclick = ()=>{
  if (test.mode !== 'test') return;
  const it = currentItem(); if(!it) return;
  const tZ = speciesTargetZ({kind: it.charge? 'ion':'element', Z: it.Z, charge: it.charge||0});
  if (tZ == null) return;

  if (state.Z !== tZ){
    decPoint();
    warn("Incorrect submission", `Target requires ${tZ} electrons; you submitted ${state.Z}.`);
    return;
  }

  if (test.requireQN){
    const q = state.lastQN;
    if (!q){
      decPoint();
      warn("Missing last electron","No last electron recorded. Place the final electron and re-submit.");
      return;
    }
    const n  = Number(document.getElementById('qn_n').value||NaN);
    const l  = document.getElementById('qn_l').value==='' ? NaN : Number(document.getElementById('qn_l').value);
    const ml = Number(document.getElementById('qn_ml').value||NaN);
    const ms = document.getElementById('qn_ms').value || '';
    const L=L_FROM_SUB[q.sub]; const mlList=mlSeq(q.sub);
    const ok = (n===q.n) && (l===L) && mlList.includes(ml) && (ms===q.m_s);
    if (!ok){
      decPoint();
      warn("Quantum numbers mismatch",
           `Expected n=${q.n}, ℓ=${L} (${q.sub}), mℓ ∈ [${mlList[0]}…${mlList[mlList.length-1]}] (chosen ${q.m_l}), mₛ=${q.m_s}.`);
      return;
    }
  }

  writeResult(true,'submit_ok');
  advanceItem();
};
function advanceItem(){
  alert(`Correct! Earned ${test.score}/${test.pointsPer}.`);
  const myRef = fb.db.ref(`${paths.progressRoot()}/${live.me.id}`);
  const next = (test.idx+1);
  myRef.set(next).catch(()=>{});
  resetBoard();
}

/* write result */
function writeResult(ok, reason){
  if(!fb.db || !live.classKey || !live.sessionId) return;
  const it = currentItem();
  const ts=Date.now();
  const payload={
    ok: !!ok,
    reason: reason||null,
    earned: ok ? test.score : 0,
    pointsPer: test.pointsPer,
    requireQN: test.requireQN,
    target: it ? { Z: it.Z, charge: it.charge||0, ng: !!it.ng } : null,
    zFinal: state.Z,
    cfg: cfgPlain(),
    sh: shorthand(),
    lastQN: state.lastQN,
    itemIndex: test.idx,
    at: ts,
    who: live.me.id || 'anon',
    name: live.me.name || null
  };
  fb.db.ref(`${paths.results()}/${live.me.id}/${ts}`).set(payload).catch(()=>{});
}

/* reset board */
function resetBoard(){
  for(const k in state.orbitals) state.orbitals[k]=[];
  document.querySelectorAll('.orbital').forEach(b=>{ b.innerHTML=''; b.classList.remove('full'); });
  state.Z=0; state.history=[]; state.lastQN=null; syncReadouts(); syncQuantumLast();
  document.getElementById('qn_n').value=''; document.getElementById('qn_l').value=''; document.getElementById('qn_ml').value=''; document.getElementById('qn_ms').value='';
}

/* ========== Roster & Scores with Right/Total and CLASS TOTALS ========== */
const roster = new Map(); // id -> {name, at}
const totals = new Map(); // id -> {sum, last, right, total}
function subscribeRoster(reset){
  if(!fb.db) return;
  const ref = fb.db.ref(paths.students());
  if(reset) try{ ref.off(); }catch{}
  ref.on('child_added', snap=>{
    const id=snap.key, v=snap.val()||{};
    roster.set(id,{name:v.name||null, at:v.at||0}); renderScores();
  });
  ref.on('child_changed', snap=>{
    const id=snap.key, v=snap.val()||{};
    roster.set(id,{name:v.name||null, at:v.at||0}); renderScores();
  });
  ref.on('child_removed', snap=>{ roster.delete(snap.key); renderScores(); });
}
function subscribeScores(reset){
  if(!fb.db) return;
  const ref = fb.db.ref(paths.results());
  if(reset) try{ ref.off(); }catch{}
  ref.on('value', snap=>{
    totals.clear();
    const all = snap.val()||{};
    Object.keys(all).forEach(id=>{
      let sum=0, last=0, right=0, total=0;
      const items = all[id]||{};
      Object.keys(items).forEach(ts=>{
        const r = items[ts];
        sum += Number(r.earned||0);
        last = Math.max(last, Number(r.at||0));
        total += 1;
        if(r.ok) right += 1;
      });
      totals.set(id,{sum,last,right,total});
    });
    renderScores();
  });
}
function renderScores(){
  const body = document.getElementById('scoreBody'); if(!body) return;
  body.innerHTML='';
  const rows=[];
  const ids = new Set([...roster.keys(), ...totals.keys()]);
  ids.forEach(id=>{
    const r = roster.get(id)||{};
    const t = totals.get(id)||{sum:0,last:0,right:0,total:0};
    rows.push({
      id,
      name: (r.name && String(r.name).trim()) ? r.name.trim() : '(no name)',
      sum: t.sum||0,
      last: t.last||0,
      right: t.right||0,
      total: t.total||0
    });
  });
  rows.sort((a,b)=> (b.sum-a.sum) || ((b.last||0)-(a.last||0)) || a.name.localeCompare(b.name));

  // Aggregate totals
  const studentCount = rows.length;
  const classRight = rows.reduce((s,r)=>s+(r.right||0), 0);
  const classTotal = rows.reduce((s,r)=>s+(r.total||0), 0);
  const classPoints = rows.reduce((s,r)=>s+(r.sum||0), 0);
  const pct = classTotal ? Math.round((classRight/classTotal)*100) : 0;
  const avgPts = studentCount ? (classPoints / studentCount) : 0;

  const totalsEl = document.getElementById('classTotals');
  if (totalsEl){
    totalsEl.innerHTML = `
      <strong>Class totals:</strong>
      Students: ${studentCount} • Right: ${classRight} / Total: ${classTotal}
      (${pct}% correct) • Points: ${classPoints} • Avg points/student: ${avgPts.toFixed(1)}
    `;
  }

  // Render rows
  rows.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(row.name)}</td>
                    <td>${row.right} / ${row.total}</td>
                    <td>${row.sum}</td>
                    <td>${fmtTime(row.last)}</td>
                    <td class="tiny">${row.id}</td>`;
    body.appendChild(tr);
  });
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function exportCSV(){
  const rows = document.querySelectorAll('#scoreBody tr');

  // Aggregate to prepend totals row
  let studentCount = 0, classRight = 0, classTotal = 0, classPoints = 0;
  rows.forEach(tr=>{
    studentCount++;
    const tds = [...tr.children].map(td=>td.textContent);
    const [rightStr, totalStr] = tds[1].split('/').map(s=>s.trim());
    classRight  += Number(rightStr||0);
    classTotal  += Number(totalStr||0);
    classPoints += Number(tds[2]||0);
  });
  const pct = classTotal ? Math.round((classRight/classTotal)*100) : 0;
  const avgPts = studentCount ? (classPoints/studentCount) : 0;

  const lines = [];
  lines.push(['Class totals',
              `Students=${studentCount}`,
              `Right=${classRight}`,
              `Total=${classTotal}`,
              `Percent=${pct}%`,
              `Points=${classPoints}`,
              `AvgPoints=${avgPts.toFixed(1)}`]);
  lines.push(['Student','Right','Total','Points','Last Submit','ID']);

  rows.forEach(tr=>{
    const tds=[...tr.children].map(td=>td.textContent);
    const [rightStr, totalStr] = tds[1].split('/').map(s=>s.trim());
    lines.push([tds[0], rightStr, totalStr, tds[2], tds[3], tds[4]]);
  });

  function csvEscape(s){ const str = String(s == null ? '' : s); return /[",\n]/.test(str) ? '"' + str.replace(/"/g,'""') + '"' : str; }
  const csv = lines.map(row => row.map(csvEscape).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`ec-scores-${live.classKey}-${live.sessionId}.csv`; a.click();
  URL.revokeObjectURL(url);
}

/* ========== Teacher Panel: build periodic chart + queue ========== */
const queue = []; // items: {Z, charge, ng}
function renderQueue(){
  const wrap = document.getElementById('queue'); wrap.innerHTML='';
  document.getElementById('qCount').textContent = String(queue.length);
  if(!queue.length){ wrap.innerHTML = '<div class="hint">Queue is empty. Click elements on the chart to add.</div>'; return; }
  queue.forEach((it,idx)=>{
    const sym = SYMBOLS[it.Z]||'?';
    const ch = it.charge||0;
    const ion = ch===0 ? '' : (ch>0?`^${ch}+`:`^${Math.abs(ch)}-`);
    const row=document.createElement('div'); row.className='queue-item';
    row.innerHTML = `
      <span class="chip" title="atomic number">Z=${it.Z}</span>
      <strong>${sym}${ion}</strong>
      <button class="btn" data-act="minus" data-idx="${idx}">−</button>
      <button class="btn" data-act="plus" data-idx="${idx}">+</button>
      <label class="tiny"><input type="checkbox" data-act="ng" data-idx="${idx}" ${it.ng?'checked':''}> NG</label>
      <button class="btn warn" data-act="del" data-idx="${idx}">Remove</button>
    `;
    wrap.appendChild(row);
  });
}
document.addEventListener('click', (e)=>{
  const act = e.target?.dataset?.act; if(!act) return;
  const idx = Number(e.target.dataset.idx);
  if(Number.isNaN(idx)) return;
  const it = queue[idx]; if(!it) return;
  if(act==='plus'){ it.charge = (it.charge||0)+1; }
  if(act==='minus'){ it.charge = (it.charge||0)-1; }
  if(act==='ng'){ it.ng = !!e.target.checked; }
  if(act==='del'){ queue.splice(idx,1); }
  renderQueue();
});
document.getElementById('tp_clearQueue').onclick = ()=>{ queue.length=0; renderQueue(); };

function buildPeriodicGrid(){
  const pt = document.getElementById('pt'); pt.innerHTML='';
  function blank(n){ for(let i=0;i<n;i++){ const b=document.createElement('div'); b.className='pt-btn pt-blank'; pt.appendChild(b);} }
  function btn(z){
    const b=document.createElement('button');
    b.type='button'; b.className='pt-btn'; b.textContent = SYMBOLS[z]||'?'; b.title = `${SYMBOLS[z]||'?'} (Z=${z})`;
    b.addEventListener('click', ()=>{ queue.push({Z:z, charge:0, ng:false}); renderQueue(); });
    pt.appendChild(b);
  }
  // Period 1
  blank(0); btn(1); blank(16); btn(2);
  // Period 2
  btn(3); btn(4); blank(10); btn(5); btn(6); btn(7); btn(8); btn(9); btn(10);
  // Period 3
  btn(11); btn(12); blank(10); btn(13); btn(14); btn(15); btn(16); btn(17); btn(18);
  // Period 4
  btn(19); btn(20); btn(21); btn(22); btn(23); btn(24); btn(25); btn(26); btn(27); btn(28); btn(29); btn(30); btn(31); btn(32); btn(33); btn(34); btn(35); btn(36);
  // Period 5
  btn(37); btn(38); btn(39); btn(40); btn(41); btn(42); btn(43); btn(44); btn(45); btn(46); btn(47); btn(48); btn(49); btn(50); btn(51); btn(52); btn(53); btn(54);
  // Period 6
  btn(55); btn(56); btn(57); btn(72); btn(73); btn(74); btn(75); btn(76); btn(77); btn(78); btn(79); btn(80); btn(81); btn(82); btn(83); btn(84); btn(85); btn(86);
  // Period 7
  btn(87); btn(88); btn(89); btn(104); btn(105); btn(106); btn(107); btn(108); btn(109); btn(110); btn(111); btn(112); btn(113); btn(114); btn(115); btn(116); btn(117); btn(118);
  // f-block rows
  const strip = document.createElement('div'); strip.style.gridColumn='1 / -1'; strip.style.marginTop='8px'; pt.appendChild(strip);
  const row4f=document.createElement('div'); row4f.style.display='flex'; row4f.style.gap='4px';
  for(let z=58; z<=71; z++){ const b=document.createElement('button'); b.type='button'; b.className='pt-btn'; b.textContent=SYMBOLS[z]||'?'; b.title=`${SYMBOLS[z]||'?'} (Z=${z})`; b.onclick=()=>{ queue.push({Z:z, charge:0, ng:false}); renderQueue(); }; row4f.appendChild(b); }
  pt.appendChild(row4f);
  const row5f=document.createElement('div'); row5f.style.display='flex'; row5f.style.gap='4px'; row5f.style.marginTop='4px';
  for(let z=90; z<=103; z++){ const b=document.createElement('button'); b.type='button'; b.className='pt-btn'; b.textContent=SYMBOLS[z]||'?'; b.title=`${SYMBOLS[z]||'?'} (Z=${z})`; b.onclick=()=>{ queue.push({Z:z, charge:0, ng:false}); renderQueue(); }; row5f.appendChild(b); }
  pt.appendChild(row5f);
}

/* Send list => broadcast to class */
document.getElementById('tp_sendList').onclick = async ()=>{
  if(!queue.length){ alert('Queue is empty.'); return; }
  const pts = Number(document.getElementById('tp_points').value||5);
  const reqQN = !!document.getElementById('tp_requireQN').checked;
  const payload = {
    mode:'test',
    pointsPer: pts,
    requireQN: reqQN,
    list: queue.map(it=>({Z:it.Z, charge:it.charge||0, ng:!!it.ng})),
    version: Date.now()
  };
  await fb.db.ref(paths.currentPrompt()).set(payload);
  // Reset all student progress to 0
  await fb.db.ref(paths.progressRoot()).set(null);
  alert(`Sent ${queue.length} items.`);
};

/* Admin controls */
document.getElementById('tp_softReset').onclick = async ()=>{ await fb.db.ref(`${paths.control()}/softResetAt`).set(Date.now()); alert('Soft reset broadcasted.'); };
document.getElementById('tp_newSession').onclick = async ()=>{ await fb.db.ref(`${paths.control()}/resetAt`).set(Date.now()); alert('New session broadcasted.'); };
document.getElementById('exportBtn').onclick = ()=> exportCSV();

/* ===== UI & login ===== */
document.getElementById('setClassBtn').onclick = async ()=>{
  const val = sanitizeClassName(document.getElementById('classInput').value);
  setClassKey(val);
  document.getElementById('classLabel').textContent=live.classKey;
  const curRef = fb.db.ref(`${paths.configPath()}/currentSession`);
  let s = (await curRef.get()).val(); if(!s){ s=nowId(); await curRef.set(s); }
  live.sessionId = s; document.getElementById('sessionLabel').textContent = s.slice(-6);
  ensureStudentPresence();
  attachPromptListener(); attachResetListeners(); subscribeRoster(true); subscribeScores(true);
};
document.getElementById('shareClassBtn').onclick = async ()=>{
  const link = new URL(location.href); link.searchParams.set('class', live.classKey);
  try{ await navigator.clipboard.writeText(String(link)); alert('Join link copied:\n'+link); }
  catch(e){ prompt('Copy this link:', String(link)); }
};
document.getElementById('loginBtn').onclick = async ()=>{
  const pin = await fetchPin();
  document.getElementById('pinSetup').style.display = pin ? 'none' : '';
  document.getElementById('loginDlg').showModal();
};
document.getElementById('saveNewPinBtn').onclick = async ()=>{
  const np = document.getElementById('newPinInput').value.trim();
  if(!validPin(np)){ alert('Enter a 4-digit PIN (0-9).'); return; }
  await savePin(np); alert('PIN saved.'); document.getElementById('pinSetup').style.display='none'; document.getElementById('newPinInput').value='';
};
document.getElementById('unlockBtn').onclick = async (e)=>{
  e.preventDefault();
  const stored = await fetchPin(); const inp = document.getElementById('pinInput').value.trim();
  if(validPin(stored) && inp === stored){
    document.getElementById('loginDlg').close();
    document.getElementById('teacherPanel').classList.remove('hidden');
  } else { alert('Wrong PIN'); }
};

/* ===== Build workspace + tray + periodic chart + init DB ===== */
function buildAll(){
  buildBlocks();
  placeTrayUnder3d();
  buildPeriodicGrid();
  renderQueue();
}
window.addEventListener('load', ()=>{ buildAll(); dbInit(); });
</script>
</body>
</html>