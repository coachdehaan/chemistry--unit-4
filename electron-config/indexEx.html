<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Electron Configuration Trainer</title>

<style>
body{
  font-family:system-ui,Arial,sans-serif;
  background:#f8f8f8;
  margin:0;
  padding:0;
  overflow-x:hidden;
}
header{
  background:#1e1e1e;
  color:#fff;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h1{font-size:1.4rem;margin:0;}
#orbitalGrid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(80px,1fr));
  gap:4px;
  margin:20px auto;
  max-width:900px;
  justify-items:center;
}
.orbital{
  border:1px solid #aaa;
  border-radius:8px;
  background:#fff;
  width:80px;
  height:60px;
  position:relative;
  text-align:center;
  font-size:14px;
  line-height:1.3;
}
.orbital span{display:block;margin-top:4px;font-weight:600;}
.arrowBox{
  position:fixed;
  bottom:40px;
  right:50px;
  background:#fff;
  border:2px solid #333;
  border-radius:10px;
  padding:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
}
.arrow{
  width:20px;
  height:50px;
  border:1px solid #000;
  border-radius:4px;
  margin:4px;
  background:linear-gradient(to top,#ccc,#fff);
  cursor:grab;
  display:inline-block;
  position:relative;
}
.arrow::after{
  content:'↑';
  position:absolute;
  top:12px;
  left:4px;
  font-weight:bold;
}
#answersBox{
  max-width:700px;
  margin:20px auto;
  background:#fff;
  border:1px solid #ddd;
  border-radius:8px;
  padding:12px;
  line-height:1.4;
}
#answersBox pre{background:#f0f0f0;padding:8px;border-radius:4px;}
#showAnswersBtn{margin:10px 0;padding:6px 12px;}
.periodicGrid{
  display:grid;
  grid-template-columns:repeat(18,1fr);
  gap:2px;
  font-size:10px;
  max-width:600px;
  margin:12px auto;
}
.cell{
  border:1px solid #ccc;
  text-align:center;
  padding:2px;
  background:#eee;
}
.sblock{background:#ccf;}
.pblock{background:#cfc;}
.dblock{background:#fcc;}
.fblock{background:#fcf;}
.highlight{border:2px solid #000;}
#teacherPortalBtn{
  position:fixed;
  bottom:15px;
  right:15px;
  background:#1e1e1e;
  color:#fff;
  border:none;
  border-radius:50%;
  width:52px;
  height:52px;
  font-size:24px;
  cursor:pointer;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
}
dialog{
  border:none;
  border-radius:10px;
  padding:20px;
  max-width:480px;
  width:90%;
}
dialog::backdrop{background:rgba(0,0,0,0.5);}
</style>
</head>
<body>
<header>
  <h1>Electron Configuration Trainer</h1>
  <div id="classStatus" style="font-size:12px;color:#ccc;"></div>
</header>

<!-- Orbital grid container -->
<div id="orbitalGrid"></div>

<!-- Floating arrows box -->
<div class="arrowBox" id="arrowBox">
  <div class="arrow" draggable="true" data-spin="up"></div>
  <div class="arrow" draggable="true" data-spin="down"></div>
</div>

<!-- Answer / config display -->
<div id="answersBox">
  <button id="showAnswersBtn">Show Answers</button>
  <div id="answerContent" style="display:none;">
    <pre id="fullConfig"></pre>
    <pre id="nobleConfig"></pre>
    <pre id="quantumNums"></pre>
    <div id="periodicWrap">
      <div class="periodicGrid" id="ptable"></div>
    </div>
  </div>
</div>

<!-- Teacher Portal Button -->
<button id="teacherPortalBtn" title="Teacher Portal">👤</button>

<!-- Teacher Portal Dialog -->
<dialog id="teacherDlg">
  <div id="teacherLoginView">
    <h3>Teacher Login</h3>
    <input id="classInput" placeholder="Class Name" style="width:100%;margin-bottom:8px;">
    <input id="pinInput" type="password" placeholder="4-digit PIN" style="width:100%;margin-bottom:8px;">
    <button id="loginBtn">Login</button>
  </div>
  <div id="teacherControlView" style="display:none;">
    <h3>Teacher Controls</h3>
    <div>Class: <span id="classLabel">—</span></div>
    <button id="sendTestBtn">Send Test</button>
    <button id="resetScoresBtn">Reset Scores</button>
    <button id="endClassBtn">End Class</button>
    <div style="margin-top:10px;"><strong>Students:</strong><div id="studentList" style="font-size:12px;"></div></div>
    <button id="closeTeacherBtn" style="margin-top:10px;">Close</button>
  </div>
</dialog>
<script>
// ============ ORBITAL + CONFIG LOGIC ============
const orbitals=[
 {name:'1s',n:1,l:0,block:'s'},
 {name:'2s',n:2,l:0,block:'s'},
 {name:'2p',n:2,l:1,block:'p'},
 {name:'3s',n:3,l:0,block:'s'},
 {name:'3p',n:3,l:1,block:'p'},
 {name:'4s',n:4,l:0,block:'s'},
 {name:'3d',n:3,l:2,block:'d'},
 {name:'4p',n:4,l:1,block:'p'},
 {name:'5s',n:5,l:0,block:'s'},
 {name:'4d',n:4,l:2,block:'d'},
 {name:'5p',n:5,l:1,block:'p'},
 {name:'6s',n:6,l:0,block:'s'},
 {name:'4f',n:4,l:3,block:'f'},
 {name:'5d',n:5,l:2,block:'d'},
 {name:'6p',n:6,l:1,block:'p'},
 {name:'7s',n:7,l:0,block:'s'},
 {name:'5f',n:5,l:3,block:'f'},
 {name:'6d',n:6,l:2,block:'d'},
 {name:'7p',n:7,l:1,block:'p'}
];
const orbitalGrid=document.getElementById('orbitalGrid');
orbitals.forEach(o=>{
 const el=document.createElement('div');
 el.className=`orbital ${o.block}block`;
 el.dataset.orb=o.name;
 el.innerHTML=`<span>${o.name}</span><div class="slots"></div>`;
 orbitalGrid.appendChild(el);
});

// ============ PERIODIC TABLE (COLOR CODED) ============
const ptable=document.getElementById('ptable');
for(let r=1;r<=7;r++){
 for(let c=1;c<=18;c++){
  const cell=document.createElement('div');
  cell.classList.add('cell');
  if(c<=2) cell.classList.add('sblock');
  else if(c>=13&&c<=18) cell.classList.add('pblock');
  else if(c>=3&&c<=12) cell.classList.add('dblock');
  if(r>=6&&c>=3&&c<=17) cell.classList.add('fblock');
  ptable.appendChild(cell);
 }
}

// ============ DRAG/DROP ELECTRONS ============
let currentElectron=null;
document.querySelectorAll('.arrow').forEach(a=>{
 a.addEventListener('dragstart',e=>{
   currentElectron=a.cloneNode(true);
   e.dataTransfer.setData('text/plain',a.dataset.spin);
 });
});
document.querySelectorAll('.orbital').forEach(o=>{
 o.addEventListener('dragover',e=>e.preventDefault());
 o.addEventListener('drop',e=>{
   e.preventDefault();
   if(!currentElectron)return;
   const slots=o.querySelector('.slots');
   if(slots.children.length<2){
     slots.appendChild(currentElectron);
     currentElectron.style.margin='2px';
     currentElectron.draggable=false;
     currentElectron=null;
     updateConfiguration();
   }
 });
});

// ============ CONFIGURATION CALCULATION ============
let electronCount=0;
function updateConfiguration(){
 const filled=Array.from(document.querySelectorAll('.slots'))
   .filter(s=>s.children.length>0);
 electronCount=filled.reduce((a,s)=>a+s.children.length,0);
 const cfgParts=[];
 filled.forEach(s=>{
   const name=s.parentElement.dataset.orb;
   cfgParts.push(`${name}<sup>${s.children.length}</sup>`);
 });
 const config=cfgParts.join(' ');
 document.getElementById('fullConfig').innerHTML=config;
 updateQuantum();
 highlightElement(electronCount);
}

function highlightElement(count){
 const cells=document.querySelectorAll('.cell');
 cells.forEach(c=>c.classList.remove('highlight'));
 if(count>0&&count<=cells.length){
   cells[count-1].classList.add('highlight');
 }
}

function nobleGasShortcut(){
 const noble={2:'He',10:'Ne',18:'Ar',36:'Kr',54:'Xe',86:'Rn'};
 let base='';
 let remain=electronCount;
 for(const [z,sym]of Object.entries(noble)){
   if(remain>z){base=`[${sym}]`;remain-=z;}
 }
 return base;
}

function updateQuantum(){
 const filled=Array.from(document.querySelectorAll('.slots')).filter(s=>s.children.length>0);
 if(filled.length===0)return;
 const last=filled[filled.length-1].parentElement;
 const orb=orbitals.find(o=>o.name===last.dataset.orb);
 const n=orb.n,l=orb.l;
 const ml=0; // simplified
 const ms=filled[filled.length-1].children.length===1?'+½':'-½';
 const txt=`n=${n}, l=${l}, mₗ=${ml}, mₛ=${ms}`;
 document.getElementById('quantumNums').textContent=txt;
}

// ============ SHOW/HIDE ANSWERS ============
document.getElementById('showAnswersBtn').onclick=()=>{
 const box=document.getElementById('answerContent');
 const showing=box.style.display==='block';
 box.style.display=showing?'none':'block';
 document.getElementById('showAnswersBtn').textContent=showing?'Show Answers':'Hide Answers';
};
</script>
<!-- ================== FIREBASE / TEACHER PORTAL LOGIC ================== -->
<!-- Firebase Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// ============ FIREBASE CONFIG ============
const fbCfg={
 apiKey:"AIzaSyAal8uHe9nePGimXiRPZAnBl0ucQlKnXNo",
 authDomain:"presentation-83d1f.firebaseapp.com",
 databaseURL:"https://presentation-83d1f-default-rtdb.firebaseio.com",
 projectId:"presentation-83d1f",
 storageBucket:"presentation-83d1f.firebasestorage.app",
 messagingSenderId:"132406143951",
 appId:"1:132406143951:web:9695690023bd3f2aedc0ba"
};

// ============ GLOBAL STATE ============
let fb={app:null,db:null,auth:null};
let classKey=null,pin=null;
let teacherMode=false;
let studentId=localStorage.getItem('ec_uid')||Math.random().toString(36).slice(2,9);
localStorage.setItem('ec_uid',studentId);
let studentName=localStorage.getItem('ec_name')||"Student";
let classRef=null;

// ============ INIT FIREBASE ============
window.addEventListener('load',()=>{
 try{
   fb.app=firebase.initializeApp(fbCfg);
   fb.db=firebase.database();
   fb.auth=firebase.auth();
   fb.auth.signInAnonymously().catch(()=>console.log("Anon auth failed"));
 }catch(e){console.log("Firebase init err",e);}
 document.getElementById('teacherPortalBtn').onclick=openTeacherDialog;
 document.getElementById('loginBtn').onclick=teacherLogin;
 document.getElementById('closeTeacherBtn').onclick=()=>$('#teacherDlg').close();
 document.getElementById('sendTestBtn').onclick=broadcastPrompt;
 document.getElementById('resetScoresBtn').onclick=resetScores;
 document.getElementById('endClassBtn').onclick=endClass;
});

function $(s){return document.querySelector(s);}

// ============ TEACHER LOGIN ============
function openTeacherDialog(){
 document.getElementById('teacherLoginView').style.display='block';
 document.getElementById('teacherControlView').style.display='none';
 $('#teacherDlg').showModal();
}

async function teacherLogin(){
 classKey=$('#classInput').value.trim().toUpperCase();
 pin=$('#pinInput').value.trim();
 if(!classKey||!pin){alert("Enter class and PIN.");return;}
 teacherMode=true;
 classRef=fb.db.ref(`electronConfig/${classKey}`);
 await classRef.child('teacherPin').set(pin);
 $('#classLabel').textContent=classKey;
 document.getElementById('teacherLoginView').style.display='none';
 document.getElementById('teacherControlView').style.display='block';
 attachStudentListener();
}

// ============ STUDENT LISTENER ============
function attachStudentListener(){
 if(!classRef)return;
 classRef.child('students').on('value',snap=>{
   const data=snap.val()||{};
   const lines=[];
   let total=0,avgCount=0;
   for(const [id,s] of Object.entries(data)){
     lines.push(`${s.name||'—'}: ${s.score||0}/${s.total||0}`);
     if(s.total>0){total+=s.score/s.total;avgCount++;}
   }
   $('#studentList').innerHTML=lines.join('<br>');
   if(avgCount>0){
     const pct=(total/avgCount*100).toFixed(1);
     document.getElementById('classStatus').textContent=`${classKey}: ${pct}% avg`;
   }
 });
}

// ============ SCORE PUSH ============
let currentScore=0,totalPoints=0;
function pushScore(correct){
 if(teacherMode||!classKey)return;
 const ref=fb.db.ref(`electronConfig/${classKey}/students/${studentId}`);
 if(correct)currentScore++;
 totalPoints++;
 ref.update({name:studentName,score:currentScore,total:totalPoints});
}

// ============ TEST BROADCAST ============
function broadcastPrompt(){
 if(!teacherMode||!classRef)return;
 alert("Test sent (students will sync next item).");
}

// ============ RESET & END ============
function resetScores(){
 if(!teacherMode||!classRef)return;
 classRef.child('students').get().then(s=>{
   const d=s.val()||{};
   for(const id in d){
     classRef.child(`students/${id}/score`).set(0);
     classRef.child(`students/${id}/total`).set(0);
   }
 });
}
function endClass(){
 if(!teacherMode||!classRef)return;
 if(confirm("End class and clear roster?"))classRef.remove();
 $('#teacherDlg').close();
}

// ============ AUTO CLASS MEMORY ============
(function rememberClass(){
 const last=localStorage.getItem('ec_class');
 if(last){classKey=last;$('#classStatus').textContent=`Class: ${last}`;}
})();
</script>
<!-- ================== FINAL LOGIC / EXCEPTIONS / INIT ================== -->
<script>
// ======= EXCEPTIONS & NOBLE GAS PREFILL =======
function autoFillNobleGas(){
  // Fill all orbitals up to the noble gas baseline when testing mode requires it
  const nobleGasLevels={2:'1s',10:'2p',18:'3p',36:'4p',54:'5p',86:'6p'};
  let base=0;
  Object.keys(nobleGasLevels).forEach(k=>{
    if(electronCount>k) base=k;
  });
  const fillTo=base>0?nobleGasLevels[base]:null;
  if(!fillTo)return;
  orbitals.forEach(o=>{
    const slot=o.name;
    const cell=document.querySelector(`[data-orb='${slot}'] .slots`);
    if(!cell)return;
    if(fillTo&&orbitals.indexOf(o)<=orbitals.findIndex(x=>x.name===fillTo)){
      const need=(o.block==='s'?2:(o.block==='p'?6:(o.block==='d'?10:(o.block==='f'?14:2))));
      for(let i=0;i<need;i++){
        const el=document.createElement('div');
        el.className='arrow';
        el.style.margin='2px';
        cell.appendChild(el);
      }
    }
  });
}

// Cu and Cr exception adjustor
function correctExceptions(){
  const configText=document.getElementById('fullConfig').textContent;
  if(configText.includes('3d')&&configText.includes('4s²')){
    if(configText.includes('3d⁹'))document.getElementById('fullConfig').textContent=configText.replace('4s²','4s¹');
    if(configText.includes('3d⁴'))document.getElementById('fullConfig').textContent=configText.replace('4s²','4s¹');
  }
}

// ======= AUTO-SCORING HOOKS =======
function checkSubmission(){
  // Example scoring: simplistic placeholder; extend with your rules.
  const filled=Array.from(document.querySelectorAll('.slots')).filter(s=>s.children.length>0);
  const correct=(filled.length===electronCount); // stub condition
  pushScore(correct);
  if(!correct && totalPoints%3===0){
    alert('Too many electrons placed. Points deducted.');
  }
  correctExceptions();
}

// ======= INITIALIZATION GLUE =======
window.addEventListener('load',()=>{
  // If a class exists locally, auto-reconnect for students
  const storedClass=localStorage.getItem('ec_class');
  if(storedClass){classKey=storedClass;$('#classStatus').textContent=`Class: ${storedClass}`;}
  // Observe submissions
  document.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!teacherMode){
      checkSubmission();
    }
  });
});
</script>
</body>
</html>
