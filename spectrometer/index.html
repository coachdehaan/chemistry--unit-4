<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Webcam Spectrometer – Mr. D (Final)</title>
<style>
  :root{--bg:#0d1117;--ink:#e6edf3;--mut:#8b949e;--acc:#58a6ff;--grid:#30363d}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:8px 12px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-size:16px;margin:0 8px 0 0}
  .warn{background:#331;color:#f6d7d7;padding:4px 8px;border-radius:8px;border:1px solid #633}
  main{display:grid;grid-template-columns:1.1fr 1fr;gap:12px;padding:12px;align-items:start}
  .panel{border:1px solid var(--grid);border-radius:10px;overflow:hidden;background:#0f141b;min-width:0}
  .p-h{padding:8px 10px;background:#0b0f14;border-bottom:1px solid var(--grid);font-weight:600}
  .p-b{padding:10px}
  #viewwrap{position:relative;background:#000}
  #viewwrap.mirror{transform:scaleX(-1);transform-origin:center}
  video,canvas{max-width:100%;display:block}
  #draw{position:absolute;inset:0;pointer-events:none}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  label{color:var(--mut)}
  input,select,button{background:#0b0f14;color:var(--ink);border:1px solid var(--grid);border-radius:8px;padding:6px 8px}
  button{cursor:pointer}
  #plot{width:100%;height:100%;min-height:480px;background:#000;border:1px solid var(--grid);border-radius:8px;display:block}
  #log{white-space:pre-wrap;background:#0b0f14;border:1px solid var(--grid);border-radius:8px;padding:8px;min-height:64px}
  .small{font-size:12px;color:var(--mut)}
  #legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .legend-item{display:flex;align-items:center;gap:6px;background:#0b0f14;border:1px solid #2a2f35;border-radius:8px;padding:2px 6px;font:13px ui-monospace,Consolas,Menlo}
  .sw{width:12px;height:12px;border-radius:3px;border:1px solid #222}
</style>
</head>
<body>
<header>
  <h1>Webcam Spectrometer</h1>
  <span id="httpsWarn" class="warn" style="display:none">Not HTTPS. Use GitHub Pages (https://).</span>
</header>

<main>
  <section class="panel">
    <div class="p-h">Live Preview</div>
    <div class="p-b" id="viewwrap">
      <video id="vid" playsinline muted autoplay></video>
      <canvas id="draw"></canvas>
    </div>

    <div class="p-h">Capture / Calibration</div>
    <div class="p-b">
      <div class="row">
        <button id="start">Start Camera</button>
        <label>Camera <select id="cams"></select></label>
        <label>Resolution
          <select id="res">
            <option>640x480</option>
            <option selected>1280x720</option>
            <option>1920x1080</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>ROI size <input id="roiSize" type="number" value="200" min="40" max="400" style="width:80px"></label>
        <label>Smooth <input id="smooth" type="number" value="3" min="1" max="25" style="width:60px"></label>
        <button id="autoH">Auto-Cal (H₂)</button>
        <button id="findPeaks">Find Peaks</button>
      </div>
      <div class="row small">Drag the blue square over the bright rainbow band (Shift+drag = resize)</div>
      <div id="log" class="small"></div>
    </div>
  </section>

  <section class="panel">
    <div class="p-h">Intensity vs Wavelength</div>
    <div class="p-b">
      <canvas id="plot"></canvas>
      <div class="row">
        <label>Channel
          <select id="mode">
            <option value="lum" selected>Luminance</option>
            <option value="r">Red</option>
            <option value="g">Green</option>
            <option value="b">Blue</option>
          </select>
        </label>
        <label>Gamma <input id="gamma" type="number" value="1.0" step="0.1" min="0.3" max="3" style="width:70px"></label>
        <label>Subtract BG <input id="bg" type="checkbox"></label>
        <label>Top N <input id="topN" type="number" value="5" min="1" max="10" style="width:56px"></label>
      </div>
      <div id="legend"></div>
    </div>
  </section>
</main>

<script>
const $=s=>document.querySelector(s);
const vid=$('#vid'),draw=$('#draw'),plot=$('#plot');
const ctxD=draw.getContext('2d'),ctxP=plot.getContext('2d');
const log=t=>{$('#log').textContent+=(($('#log').textContent?'\n':'')+t);console.log(t);}
if(!window.isSecureContext)$('#httpsWarn').style.display='inline-block';

let stream=null,mirrorX=false,dragging=false,last={x:0,y:0};
let roi={x:200,y:200,w:200,h:200};
function clampROI(){roi.w=Math.max(120,Math.min(draw.width,roi.w));roi.h=roi.w;
roi.x=Math.max(0,Math.min(draw.width-roi.w,roi.x));
roi.y=Math.max(0,Math.min(draw.height-roi.h,roi.y));}
$('#roiSize').oninput=()=>{roi.w=roi.h=parseInt($('#roiSize').value,10);clampROI();};

$('#viewwrap').onmousedown=e=>{const r=e.currentTarget.getBoundingClientRect();
last.x=e.clientX-r.left;last.y=e.clientY-r.top;dragging=e.shiftKey?'resize':'move';};
window.onmousemove=e=>{
if(!dragging)return;const r=$('#viewwrap').getBoundingClientRect();
const x=e.clientX-r.left,y=e.clientY-r.top;
if(dragging==='move'){roi.x+=x-last.x;roi.y+=y-last.y;}
else{roi.w+=y-last.y;roi.h=roi.w;$('#roiSize').value=Math.round(roi.w);}
last.x=x;last.y=y;clampROI();};
window.onmouseup=()=>dragging=false;

async function startCamera(){
if(stream){stream.getTracks().forEach(t=>t.stop());}
await navigator.mediaDevices.getUserMedia({video:true});
const devs=await navigator.mediaDevices.enumerateDevices();
const cams=devs.filter(d=>d.kind==='videoinput');
const sel=$('#cams');sel.innerHTML='';cams.forEach((d,i)=>{const o=document.createElement('option');
o.value=d.deviceId;o.textContent=d.label||`Camera ${i+1}`;sel.appendChild(o);});
stream=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:sel.value||cams[0].deviceId}},audio:false});
vid.srcObject=stream;await vid.play();
const facing=stream.getVideoTracks()[0].getSettings().facingMode||'';mirrorX=(facing==='user');
if(mirrorX)$('#viewwrap').classList.add('mirror');else $('#viewwrap').classList.remove('mirror');
draw.width=vid.videoWidth;draw.height=vid.videoHeight;requestAnimationFrame(loop);log('Camera started');
}
$('#start').onclick=startCamera;

function getProfile(){
const y0=Math.max(0,Math.round(roi.y)),rows=Math.max(1,Math.round(roi.h));
const sx=mirrorX?(draw.width-roi.x-roi.w):roi.x;
const data=ctxD.getImageData(sx,y0,roi.w,rows).data;
const R=new Float32Array(roi.w),G=new Float32Array(roi.w),B=new Float32Array(roi.w);
for(let r=0;r<rows;r++){for(let x=0;x<roi.w;x++){const i=(r*roi.w+x)*4;R[x]+=data[i];G[x]+=data[i+1];B[x]+=data[i+2];}}
for(let x=0;x<roi.w;x++){R[x]/=rows;G[x]/=rows;B[x]/=rows;}
const g=Math.max(0.3,parseFloat($('#gamma').value));
const L=new Float32Array(roi.w);
for(let x=0;x<roi.w;x++){const r=Math.pow(R[x]/255,1/g),gr=Math.pow(G[x]/255,1/g),b=Math.pow(B[x]/255,1/g);
L[x]=0.2126*r+0.7152*gr+0.0722*b;}
return {R,G,B,L};
}

function findLocalPeaks(Y,{relProm=0.04}={}){
const minDist=Math.max(8,Math.round(Y.length/40));const absMax=Math.max(...Y)||1;
const minProm=absMax*relProm,cand=[];
for(let i=1;i<Y.length-1;i++){if(Y[i]>Y[i-1]&&Y[i]>=Y[i+1]){
let base=Math.min(Y[i-8]||Y[i],Y[i+8]||Y[i]);const prom=Y[i]-base;
if(prom>=minProm)cand.push({idx:i,amp:Y[i]});}}
cand.sort((a,b)=>b.amp-a.amp);
const kept=[];for(const c of cand){if(kept.every(k=>Math.abs(k.idx-c.idx)>=minDist))kept.push(c);}return kept;}

let peaks=[];
$('#findPeaks').onclick=()=>{
const P=getProfile();const Y=P.L;const found=findLocalPeaks(Y);const N=Math.min(found.length,parseInt($('#topN').value,10)||5);
peaks=found.slice(0,N);const leg=$('#legend');leg.innerHTML='';
for(const p of peaks){const item=document.createElement('div');item.className='legend-item';
const sw=document.createElement('span');sw.className='sw';sw.style.background='#58a6ff';
const lbl=document.createElement('span');lbl.textContent=`px ${p.idx}`;item.append(sw,lbl);leg.appendChild(item);}
log('Found '+peaks.length+' peaks.');
};

$('#autoH').onclick=()=>{
const P=getProfile().L;const found=findLocalPeaks(P);if(found.length<3){log('Auto-Cal: not enough peaks');return;}
const top=found.slice(0,3).sort((a,b)=>a.idx-b.idx);
log('Auto-Cal peaks px '+top.map(p=>p.idx).join(', '));
};

function drawPlot(){
if(vid.readyState>=2){ctxD.drawImage(vid,0,0,draw.width,draw.height);
ctxD.strokeStyle='rgba(88,166,255,.9)';ctxD.lineWidth=2;ctxD.strokeRect(roi.x,roi.y,roi.w,roi.h);}
const P=getProfile();const Y=P.L;plot.width=plot.clientWidth;plot.height=plot.clientHeight;
const Wp=plot.width,Hp=plot.height;ctxP.fillStyle='#000';ctxP.fillRect(0,0,Wp,Hp);
const max=Math.max(...Y)||1;ctxP.strokeStyle='#58a6ff';ctxP.lineWidth=2;ctxP.beginPath();
for(let i=0;i<Y.length;i++){const x=i/roi.w*Wp;const y=Hp-(Y[i]/max)*(Hp-70)-20;if(i===0)ctxP.moveTo(x,y);else ctxP.lineTo(x,y);}
ctxP.stroke();
requestAnimationFrame(drawPlot);}
function loop(){requestAnimationFrame(loop);}
requestAnimationFrame(drawPlot);
</script>
</body>
</html>
