<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Webcam Spectrometer – Mr. D</title>
<style>
  :root{--bg:#0d1117;--ink:#e6edf3;--mut:#8b949e;--acc:#58a6ff;--grid:#30363d}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:8px 12px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-size:16px;margin:0 8px 0 0}
  .warn{background:#331;color:#f6d7d7;padding:4px 8px;border-radius:8px;border:1px solid #633}

  main{display:grid;grid-template-columns:1.15fr 1fr;gap:12px;padding:12px;align-items:start}
  .panel{border:1px solid var(--grid);border-radius:10px;overflow:hidden;background:#0f141b;min-width:0}
  .p-h{padding:8px 10px;background:#0b0f14;border-bottom:1px solid var(--grid);font-weight:600}
  .p-b{padding:10px}

  #viewwrap{position:relative;background:#000}
  #viewwrap.mirror{transform:scaleX(-1);transform-origin:center}
  video,canvas{max-width:100%;display:block}
  #draw{position:absolute;inset:0;pointer-events:none}

  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  label{color:#9aa0a6}
  input,select,button{background:#0b0f14;color:var(--ink);border:1px solid var(--grid);border-radius:8px;padding:6px 8px}
  button{cursor:pointer}

  #plot{width:100%;height:100%;min-height:480px;background:#000;border:1px solid var(--grid);border-radius:8px;display:block}
  #legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .legend-item{display:flex;align-items:center;gap:6px;background:#0b0f14;border:1px solid #2a2f35;border-radius:8px;padding:2px 6px;font:13px ui-monospace,Consolas,Menlo}
  .sw{width:12px;height:12px;border-radius:3px;border:1px solid #222}

  #log{white-space:pre-wrap;background:#0b0f14;border:1px solid var(--grid);border-radius:8px;padding:8px;min-height:64px}
  .small{font-size:12px;color:var(--mut)}

  #clipWarn{color:#ff8a3c;display:none}

  /* Quick-Cal overlay */
  #wiz{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:1000}
  #wiz .card{background:#0f141b;border:1px solid var(--grid);border-radius:10px;max-width:520px;width:92%;padding:12px}
  #wiz h3{margin:0 0 6px 0;font-size:16px}
  #wiz p{margin:4px 0;color:var(--mut)}
  #wiz .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  /* Student Quick Sheet */
  details.quick{border:1px solid var(--grid); border-radius:10px; background:#0f141b; margin:12px 12px 0; overflow:hidden}
  details.quick > summary{cursor:pointer; padding:10px; font-weight:600; background:#0b0f14; list-style:none; border-bottom:1px solid var(--grid)}
  .quick-body{padding:12px}
  .steps{counter-reset: step; display:grid; gap:8px}
  .steps .step{border:1px dashed #2a2f35; border-radius:10px; padding:10px}
  .steps .step h4{margin:0 0 6px 0; font-size:14px}
  .steps .step h4::before{counter-increment: step; content: counter(step) ". "; color:var(--acc)}
  .kbd{font:12px ui-monospace,Consolas,Menlo; background:#11161d; border:1px solid #2a2f35; border-radius:6px; padding:2px 6px}
  .callout{background:#10161f;border:1px solid #2a2f35;border-radius:8px;padding:8px;margin-top:8px;color:#cfd6de}

  /* Concept diagram */
  section.diagram{margin:12px}
  @media print{
    header,#legend,#log{display:none!important}
    main{grid-template-columns:1fr!important;padding:0}
    .panel{border:none}
    details.quick{border:none}
    details.quick > summary{background:none;border:none;padding:0}
    .quick-body{padding:0}
  }
</style>
</head>
<body>
<header>
  <h1>Webcam Spectrometer</h1>
  <span id="httpsWarn" class="warn" style="display:none">Not HTTPS. Use GitHub Pages (https://).</span>
</header>

<main>
  <!-- LEFT: PREVIEW + CONTROLS + CALIBRATION -->
  <section class="panel">
    <div class="p-h">Live Preview</div>
    <div class="p-b" id="viewwrap">
      <video id="vid" playsinline muted autoplay></video>
      <canvas id="draw"></canvas>
    </div>

    <div class="p-h">Capture / Controls</div>
    <div class="p-b">
      <div class="row">
        <button id="start">Start Camera</button>
        <label>Camera <select id="cams"></select></label>
        <label>Resolution
          <select id="res">
            <option>640x480</option>
            <option selected>1280x720</option>
            <option>1920x1080</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>ROI size <input id="roiSize" type="number" value="220" min="120" max="500" style="width:80px"></label>
        <label>Avg rows <input id="avg" type="number" value="12" min="1" max="200" style="width:70px"></label>
        <label>Smooth <input id="smooth" type="number" value="3" min="1" max="25" style="width:60px"></label>
        <button id="snap">Snapshot PNG</button>
        <button id="csv">Export CSV</button>
      </div>
      <div class="row small">Drag the blue square to cover a bright 1st-order band. Shift+drag to resize. Front camera is mirrored; dragging obeys mirror.</div>
      <div class="row"><div id="log" class="small"></div></div>
    </div>

    <div class="p-h">Calibration</div>
    <div class="p-b">
      <div class="row">
        <b>2-point:</b>
        <button class="pick" data-idx="0">Pick px A</button> λA
        <input class="lam" data-idx="0" type="number" value="546.1" step="0.1" style="width:90px"> <span id="p0" class="small">pxA: –</span>
        <button class="pick" data-idx="1">Pick px B</button> λB
        <input class="lam" data-idx="1" type="number" value="589.0" step="0.1" style="width:90px"> <span id="p1" class="small">pxB: –</span>
        <button id="apply2">Apply 2-pt</button> <span id="eq2" class="small"></span>
      </div>
      <div class="row">
        <b>3-point:</b>
        <button class="pick" data-idx="2">Pick px C</button> λC
        <input class="lam" data-idx="2" type="number" value="656.3" step="0.1" style="width:90px"> <span id="p2" class="small">pxC: –</span>
        <button id="apply3">Apply 3-pt</button> <span id="eq3" class="small"></span>
      </div>
      <div class="row">
        <button id="autoH">Auto-Cal (H₂)</button>
        <button id="autoRough">Auto-Cal (Rough)</button>
        <button id="quickH">Hydrogen Quick-Cal (guided)</button>
        <span class="small">H-γ 434.0, H-β 486.1, H-α 656.3 nm.</span>
      </div>
      <div class="small">Other lines: Hg 435.8, 546.1, 577.0/579.1; Na 589.0; K 766.5/769.9.</div>
    </div>
  </section>

  <!-- RIGHT: PLOT + PEAKS -->
  <section class="panel">
    <div class="p-h">Intensity vs Wavelength</div>
    <div class="p-b" style="display:flex;flex-direction:column;gap:10px;">
      <div id="plotWrap" style="flex:1;display:flex;">
        <canvas id="plot" style="flex:1;"></canvas>
      </div>

      <div class="row">
        <label>Channel
          <select id="mode">
            <option value="lum" selected>Luminance</option>
            <option value="r">Red</option>
            <option value="g">Green</option>
            <option value="b">Blue</option>
          </select>
        </label>
        <label>Gamma <input id="gamma" type="number" value="1.0" step="0.1" min="0.3" max="3" style="width:70px"></label>
        <label>Subtract BG <input id="bg" type="checkbox"></label>
        <label>Auto scale Y <input id="autoY" type="checkbox" checked></label>
        <label>Log scale <input id="logY" type="checkbox"></label>
        <button id="findPeaks">Find Peaks</button>
        <label>Top N <input id="topN" type="number" value="5" min="1" max="10" style="width:56px"></label>
        <span class="small">Cursor: <span id="cursor">px: –, λ: – nm</span></span>
        <span id="clipWarn" class="small">SENSOR CLIP: dim/close slit</span>
      </div>

      <div id="legend" style="padding-bottom:6px"></div>
    </div>
  </section>
</main>

<!-- ====== Student Quick Sheet ====== -->
<details class="quick" open>
  <summary>Student Quick Sheet — Webcam Spectrometer</summary>
  <div class="quick-body">
    <div class="steps">
      <div class="step">
        <h4>Setup</h4>
        <ul>
          <li>Click <span class="kbd">Start Camera</span> → allow camera.</li>
          <li>Drag the blue square to cover the bright spectrum band (Shift+drag to resize).</li>
          <li>Use <span class="kbd">Avg rows</span> ≈ 8–16, <span class="kbd">Smooth</span> ≈ 3–7.</li>
        </ul>
      </div>
      <div class="step">
        <h4>Optional: Quick Calibration</h4>
        <ul>
          <li><span class="kbd">Auto-Cal (H₂)</span> — with H lamp aimed at the slit/band.</li>
          <li><span class="kbd">Hydrogen Quick-Cal</span> — guided 3 clicks: 434 → 486 → 656 nm.</li>
          <li><span class="kbd">Auto-Cal (Rough)</span> — no lamp; estimates ~450–650 nm span.</li>
        </ul>
      </div>
      <div class="step">
        <h4>Measure</h4>
        <ul>
          <li>Hover the graph for wavelength (nm) or pixels if uncalibrated.</li>
          <li>Click <span class="kbd">Find Peaks</span> to label the strongest lines.</li>
          <li>Keep <span class="kbd">Auto scale Y</span> on. Try <span class="kbd">Log scale</span> if a line is very bright.</li>
        </ul>
      </div>
      <div class="step">
        <h4>Capture</h4>
        <ul>
          <li><span class="kbd">Snapshot PNG</span> — save the preview with ROI.</li>
          <li><span class="kbd">Export CSV</span> — px, λ (if calibrated), intensity.</li>
        </ul>
      </div>
    </div>
    <div class="callout">Tip: If you see “SENSOR CLIP,” dim the source, narrow the slit, or move the lamp away to avoid saturation.</div>
  </div>
</details>

<!-- ====== Concept Diagram (lightweight SVG) ====== -->
<section class="panel diagram">
  <div class="p-h">How the Webcam Spectrometer Works</div>
  <div class="p-b" id="conceptWrap">
    <svg id="conceptSVG" viewBox="0 0 900 260" width="100%" height="260" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="900" height="260" fill="#0b0f14" stroke="#30363d"/>
      <g>
        <rect x="40" y="90" width="24" height="80" fill="#111" stroke="#444"/>
        <rect x="49" y="90" width="6" height="80" fill="#ddd"/>
        <text x="52" y="185" fill="#9aa0a6" font-size="12" text-anchor="middle">slit</text>
      </g>
      <g>
        <rect x="180" y="60" width="16" height="140" fill="#1b1f24" stroke="#444"/>
        <text x="188" y="210" fill="#9aa0a6" font-size="12" text-anchor="middle">grating</text>
        <g stroke="#2a2f35" stroke-width="1">
          <line x1="182" y1="64" x2="194" y2="64"/><line x1="182" y1="72" x2="194" y2="72"/>
          <line x1="182" y1="80" x2="194" y2="80"/><line x1="182" y1="88" x2="194" y2="88"/>
          <line x1="182" y1="96" x2="194" y2="96"/><line x1="182" y1="104" x2="194" y2="104"/>
          <line x1="182" y1="112" x2="194" y2="112"/><line x1="182" y1="120" x2="194" y2="120"/>
          <line x1="182" y1="128" x2="194" y2="128"/><line x1="182" y1="136" x2="194" y2="136"/>
          <line x1="182" y1="144" x2="194" y2="144"/><line x1="182" y1="152" x2="194" y2="152"/>
          <line x1="182" y1="160" x2="194" y2="160"/><line x1="182" y1="168" x2="194" y2="168"/>
          <line x1="182" y1="176" x2="194" y2="176"/><line x1="182" y1="184" x2="194" y2="184"/>
        </g>
      </g>
      <g stroke="#58a6ff" stroke-width="1">
        <line x1="66" y1="100" x2="180" y2="80"/>
        <line x1="66" y1="130" x2="180" y2="130"/>
        <line x1="66" y1="160" x2="180" y2="180"/>
      </g>
      <g stroke-width="2">
        <line x1="196" y1="80"  x2="760" y2="100" stroke="#7b6cff"/>
        <line x1="196" y1="110" x2="760" y2="120" stroke="#3ea0ff"/>
        <line x1="196" y1="130" x2="760" y2="140" stroke="#10D27A"/>
        <line x1="196" y1="150" x2="760" y2="160" stroke="#f2c84b"/>
        <line x1="196" y1="180" x2="760" y2="180" stroke="#ff5866"/>
      </g>
      <g>
        <rect x="560" y="40" width="280" height="24" fill="#111" stroke="#2a2f35"/>
        <g stroke="#444" stroke-width="1">
          <line x1="560" y1="64" x2="560" y2="72"/>
          <line x1="700" y1="64" x2="700" y2="72"/>
          <line x1="840" y1="64" x2="840" y2="72"/>
        </g>
        <text x="560" y="88" fill="#9aa0a6" font-size="12" text-anchor="middle">0 px</text>
        <text x="700" y="88" fill="#9aa0a6" font-size="12" text-anchor="middle">mid px</text>
        <text x="840" y="88" fill="#9aa0a6" font-size="12" text-anchor="middle">max px</text>
        <text x="700" y="20" fill="#cfd6de" font-size="14" text-anchor="middle">Uncalibrated: intensity vs pixel</text>
      </g>
      <g>
        <path d="M700,110 C720,130 740,150 760,170" fill="none" stroke="#58a6ff" stroke-width="2" marker-end="url(#arrow)"/>
        <text x="740" y="150" fill="#9aa0a6" font-size="12">calibration maps pixels → λ (nm)</text>
      </g>
      <defs>
        <marker id="arrow" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto">
          <path d="M0,0 L8,4 L0,8 z" fill="#58a6ff"/>
        </marker>
      </defs>
      <g>
        <line x1="560" y1="210" x2="840" y2="210" stroke="#444"/>
        <g stroke="#444">
          <line x1="560" y1="206" x2="560" y2="214"/>
          <line x1="640" y1="206" x2="640" y2="214"/>
          <line x1="700" y1="206" x2="700" y2="214"/>
          <line x1="760" y1="206" x2="760" y2="214"/>
          <line x1="840" y1="206" x2="840" y2="214"/>
        </g>
        <text x="560" y="230" fill="#9aa0a6" font-size="12" text-anchor="middle">380</text>
        <text x="640" y="230" fill="#9aa0a6" font-size="12" text-anchor="middle">500</text>
        <text x="700" y="230" fill="#9aa0a6" font-size="12" text-anchor="middle">590</text>
        <text x="760" y="230" fill="#9aa0a6" font-size="12" text-anchor="middle">680</text>
        <text x="840" y="230" fill="#9aa0a6" font-size="12" text-anchor="middle">780</text>
        <text x="700" y="196" fill="#cfd6de" font-size="14" text-anchor="middle">Calibrated: intensity vs wavelength (nm)</text>
      </g>
    </svg>
  </div>
</section>

<!-- Hydrogen Quick-Cal overlay -->
<div id="wiz">
  <div class="card">
    <h3>Hydrogen Quick-Cal</h3>
    <p id="wizMsg">Step 1 of 3 — On the graph, click the <b>violet</b> peak <b>H-γ (434.0 nm)</b>.</p>
    <ul class="small">
      <li>Keep the bright hydrogen band inside the ROI square.</li>
      <li>Click peaks on the <b>graph</b> (not the video).</li>
    </ul>
    <div class="actions">
      <button id="wizCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const vid=$('#vid'), draw=$('#draw'), plot=$('#plot');
const ctxD=draw.getContext('2d'), ctxP=plot.getContext('2d');
const log=msg=>{$('#log').textContent+=($('#log').textContent?'\n':'')+msg; console.log(msg);};
if(!window.isSecureContext) $('#httpsWarn').style.display='inline-block';

let stream=null, mirrorX=false;
let dragging=false, last={x:0,y:0};
let selectedDeviceId=null;

// ROI square relative to full frame
let roi={x:200,y:200,w:220,h:220};
function clampROI(){
  roi.w=Math.max(120,Math.min(draw.width,roi.w));
  roi.h=roi.w;
  roi.x=Math.max(0,Math.min(draw.width-roi.w,roi.x));
  roi.y=Math.max(0,Math.min(draw.height-roi.h,roi.y));
}
$('#roiSize').oninput=()=>{roi.w=roi.h=parseInt($('#roiSize').value,10)||220;clampROI();};

// Dragging (mirror-aware)
$('#viewwrap').addEventListener('mousedown',e=>{
  const r=$('#viewwrap').getBoundingClientRect();
  last.x=e.clientX-r.left; last.y=e.clientY-r.top;
  dragging = e.shiftKey ? 'resize' : 'move';
});
window.onmousemove = e => {
  if (!dragging) return;
  const r = $('#viewwrap').getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  let dx = x - last.x;
  let dy = y - last.y;
  if (mirrorX && dragging === 'move') dx = -dx;
  if (dragging === 'move') { roi.x += dx; roi.y += dy; }
  else { roi.w += dy; roi.h = roi.w; $('#roiSize').value = Math.round(roi.w); }
  last.x = x; last.y = y; clampROI();
};
window.onmouseup = ()=> dragging=false;

// Fit canvases
function fitCanvas(){
  draw.width = vid.videoWidth || 1280;
  draw.height = vid.videoHeight || 720;
  clampROI();
  plot.width = plot.clientWidth;
  plot.height = plot.clientHeight;
}
window.addEventListener('resize', fitCanvas);

// ---------- CAMERA ----------
function makeConstraints(deviceId){
  const [w,h] = ($('#res').value||'1280x720').split('x').map(Number);
  return deviceId
    ? {video:{deviceId:{exact:deviceId}, width:{ideal:w}, height:{ideal:h}}, audio:false}
    : {video:{width:{ideal:w}, height:{ideal:h}}, audio:false};
}
async function enumerateCams(){
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d=>d.kind==='videoinput');
  const sel = $('#cams');
  const keep = selectedDeviceId || sel.value;
  sel.innerHTML='';
  cams.forEach((d,i)=>{
    const opt=document.createElement('option');
    opt.value=d.deviceId; opt.textContent=d.label||`Camera ${i+1}`;
    sel.appendChild(opt);
  });
  if (keep && cams.some(c=>c.deviceId===keep)) sel.value = keep;
  else if (cams[0]) sel.value = cams[0].deviceId;
  selectedDeviceId = sel.value || null;
  if(!cams.length) log('No cameras found.');
}
async function startWith(deviceId){
  if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  try{
    stream=await navigator.mediaDevices.getUserMedia(makeConstraints(deviceId));
  }catch(e1){
    log(`getUserMedia failed: ${e1.name} — ${e1.message}`); stream=null;
    try{ stream=await navigator.mediaDevices.getUserMedia(makeConstraints(null)); }
    catch(e2){ log(`Fallback failed: ${e2.name} — ${e2.message}`); return; }
  }
  vid.srcObject=stream; try{ await vid.play(); }catch(e){ log('video.play: '+e.name); }
  const facing = stream.getVideoTracks()[0]?.getSettings()?.facingMode || '';
  mirrorX = (facing==='user');
  if (mirrorX) $('#viewwrap').classList.add('mirror'); else $('#viewwrap').classList.remove('mirror');
  await new Promise(res=>{ if(vid.readyState>=2) res(); else vid.onloadedmetadata=res; });
  fitCanvas(); requestAnimationFrame(loop);
  log('Camera started: '+(stream.getVideoTracks()[0]?.label||'unknown'));
  setTimeout(()=>{ enumerateCams().catch(()=>{}); }, 400);
}
$('#start').onclick = async ()=>{
  $('#log').textContent='';
  if(!('mediaDevices' in navigator)){ log('ERROR: mediaDevices not available.'); return; }
  if(!window.isSecureContext){ log('ERROR: Not HTTPS.'); return; }
  try{ const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); s.getTracks().forEach(t=>t.stop()); }catch{}
  await enumerateCams(); await startWith($('#cams').value);
};
$('#cams').addEventListener('change', async e=>{ selectedDeviceId=e.target.value; await startWith(selectedDeviceId); });
$('#res').addEventListener('change', async ()=>{ await startWith(selectedDeviceId || $('#cams').value); });
if (navigator.mediaDevices?.addEventListener){
  navigator.mediaDevices.addEventListener('devicechange', async ()=>{
    const prev = selectedDeviceId; await enumerateCams();
    if ($('#cams').value !== prev){ await startWith($('#cams').value); }
  });
}

// ---------- DATA PIPE ----------
function getProfile(){
  const rows = Math.max(1, Math.round(roi.h));
  const y0 = Math.max(0, Math.round(roi.y));
  const sx = mirrorX ? (draw.width - roi.x - roi.w) : roi.x;

  const data = ctxD.getImageData(Math.round(sx), Math.round(y0), Math.round(roi.w), rows).data;
  const R=new Float32Array(roi.w),G=new Float32Array(roi.w),B=new Float32Array(roi.w);
  for(let r=0;r<rows;r++){
    for(let x=0;x<roi.w;x++){
      const i=(r*roi.w + x)*4; R[x]+=data[i]; G[x]+=data[i+1]; B[x]+=data[i+2];
    }
  }
  for(let x=0;x<roi.w;x++){ R[x]/=rows; G[x]/=rows; B[x]/=rows; }

  const gamma=Math.max(0.3, parseFloat($('#gamma').value)||1.0);
  const L=new Float32Array(roi.w);
  for(let x=0;x<roi.w;x++){
    const r=Math.pow(R[x]/255,1/gamma), g=Math.pow(G[x]/255,1/gamma), b=Math.pow(B[x]/255,1/gamma);
    L[x]=0.2126*r+0.7152*g+0.0722*b;
  }
  // horizontal smoothing
  const k=Math.max(1,parseInt($('#smooth').value,10)||1);
  const smooth=A=>{
    const out=new Float32Array(A.length);
    for(let i=0;i<A.length;i++){
      const i0=Math.max(0,i-k), i1=Math.min(A.length-1,i+k);
      let s=0; for(let j=i0;j<=i1;j++) s+=A[j]; out[i]=s/(i1-i0+1);
    } return out;
  };
  return {R:smooth(R),G:smooth(G),B:smooth(B),L:smooth(L)};
}

// ---------- PEAKS ----------
function findLocalPeaks(Y,{relProm=0.04}={}){
  const minDist=Math.max(8,Math.round(Y.length/40));
  const absMax=Math.max(...Y)||1;
  const minProm=absMax*relProm;
  const cand=[];
  for(let i=1;i<Y.length-1;i++){
    if(Y[i]>Y[i-1] && Y[i]>=Y[i+1]){
      const left = Y[Math.max(0,i-8)], right = Y[Math.min(Y.length-1,i+8)];
      const base = Math.min(left??Y[i], right??Y[i]);
      const prom = Y[i]-base;
      if (prom>=minProm) cand.push({idx:i, amp:Y[i], prom});
    }
  }
  cand.sort((a,b)=>b.amp-a.amp);
  const kept=[];
  for(const c of cand){ if(kept.every(k=>Math.abs(k.idx-c.idx)>=minDist)) kept.push(c); }
  return kept;
}
function spectrumColor(lam){
  if(!isFinite(lam)) return '#9aa0a6';
  if(lam<450) return '#7b6cff';
  if(lam<495) return '#3ea0ff';
  if(lam<510) return '#00cfd8';
  if(lam<560) return '#10d27a';
  if(lam<590) return '#f2c84b';
  if(lam<620) return '#ff8a3c';
  return '#ff5866';
}

// ---------- CALIBRATION ----------
let calibrated=false;
let calib={kind:'linear',A:NaN,B:NaN,a:NaN,b:NaN,c:NaN}; // domain is 0..roi.w-1
function pxToNm(px){ if(!calibrated) return NaN; return (calib.kind==='linear') ? (calib.A*px + calib.B) : (calib.a*px*px + calib.b*px + calib.c); }
function nmToPx(nm){
  if(!calibrated) return NaN;
  if(calib.kind==='linear') return (nm - calib.B)/calib.A;
  const {a,b,c}=calib; const A=a,B=b,C=c-nm,D=B*B-4*A*C;
  if(D<=0) return NaN;
  const r1=(-B+Math.sqrt(D))/(2*A), r2=(-B-Math.sqrt(D))/(2*A);
  if (r1>=0 && r1<=roi.w) return r1;
  if (r2>=0 && r2<=roi.w) return r2;
  return NaN;
}

// Manual pick UI
let picking=null; const picksPx=[null,null,null]; const picksNm=[546.1,589.0,656.3];
for(const l of document.querySelectorAll('.lam')) l.onchange=()=>{ picksNm[parseInt(l.dataset.idx,10)]=parseFloat(l.value); };
for(const b of document.querySelectorAll('.pick')) b.onclick=()=>{ picking=parseInt(b.dataset.idx,10); log('Click a peak on the graph to assign pixel.'); };

plot.addEventListener('mousemove',e=>{
  const r=plot.getBoundingClientRect(), x=e.clientX-r.left;
  const px=Math.max(0, Math.min(roi.w-1, Math.round(x/plot.width*roi.w)));
  const lam=pxToNm(px);
  $('#cursor').textContent = calibrated ? `px:${px} , λ:${isFinite(lam)?lam.toFixed(1):'–'} nm` : `px:${px} (uncalibrated)`;
});
plot.addEventListener('click', e=>{
  if(picking===null && !HQ.active) return;
  const r=plot.getBoundingClientRect(), x=e.clientX-r.left;
  const px=Math.max(0, Math.min(roi.w-1, Math.round(x/plot.width*roi.w)));
  if (picking!==null){
    picksPx[picking]=px; $('#p'+picking).textContent=`px${['A','B','C'][picking]}: ${px}`; picking=null; return;
  }
  // wizard route
  if(HQ.active){
    const stage=HQ.stage; picksPx[stage]=px; $('#p'+stage).textContent=`px${['A','B','C'][stage]}: ${px}`;
    HQ.stage++; if(HQ.stage===1) $('#wizMsg').innerHTML='Step 2 of 3 — Click the <b>cyan-blue</b> peak <b>H-β (486.1 nm)</b>.';
    else if(HQ.stage===2) $('#wizMsg').innerHTML='Step 3 of 3 — Click the <b>red</b> peak <b>H-α (656.3 nm)</b>.';
    else finishHydrogenQuickCal();
  }
});
$('#apply2').onclick=()=>{
  const [x1,x2]=[picksPx[0],picksPx[1]], [y1,y2]=[picksNm[0],picksNm[1]];
  if(x1==null||x2==null) return log('Pick two pixels first.');
  calibrated=true; calib.kind='linear';
  calib.A=(y2-y1)/(x2-x1); calib.B=y1 - calib.A*x1;
  $('#eq2').textContent=`λ = ${calib.A.toFixed(4)}·px + ${calib.B.toFixed(2)} (linear)`;
};
$('#apply3').onclick=()=>{
  const x=[0,1,2].map(i=>picksPx[i]), y=[0,1,2].map(i=>picksNm[i]);
  if(x.some(v=>v==null)) return log('Pick three pixels first.');
  const [x1,x2,x3]=x,[y1,y2,y3]=y; const D=(x1-x2)*(x1-x3)*(x2-x3);
  const a=(x3*(y2-y1)+x2*(y1-y3)+x1*(y3-y2))/D;
  const b=(x3*x3*(y1-y2)+x2*x2*(y3-y1)+x1*x1*(y2-y3))/D;
  const c=(x2*x3*(x2-x3)*y1 + x3*x1*(x3-x1)*y2 + x1*x2*(x1-x2)*y3)/D;
  calibrated=true; calib.kind='quad'; calib.a=a; calib.b=b; calib.c=c;
  $('#eq3').textContent=`λ = ${a.toExponential(3)}·px² + ${b.toFixed(4)}·px + ${c.toFixed(2)} (quadratic)`;
};

// Auto-Cal (H₂)
$('#autoH').onclick=()=>{
  const Y=getProfile().L;
  const found=findLocalPeaks(Y,{relProm:0.05});
  if(found.length<3){ log('Auto-Cal (H₂): need ≥3 bright H lines in ROI. Enlarge ROI / brighten / align 1st-order band.'); return; }
  found.sort((a,b)=>a.idx-b.idx);
  const left=found[0], right=found[found.length-1];
  let mid=found[Math.floor(found.length/2)];
  if (right.idx-left.idx < Math.max(60, roi.w*0.35)) { log('Auto-Cal (H₂): peaks too close. Widen ROI / align band.'); return; }
  const x1=left.idx, x2=mid.idx, x3=right.idx;
  const y1=434.0,   y2=486.1,   y3=656.3;
  const D=(x1-x2)*(x1-x3)*(x2-x3);
  const a=(x3*(y2-y1)+x2*(y1-y3)+x1*(y3-y2))/D;
  const b=(x3*x3*(y1-y2)+x2*x2*(y3-y1)+x1*x1*(y2-y3))/D;
  const c=(x2*x3*(x2-x3)*y1 + x3*x1*(x3-x1)*y2 + x1*x2*(x1-x2)*y3)/D;
  calib={kind:'quad',a,b,c}; calibrated=true;
  $('#eq3').textContent=`λ = ${a.toExponential(3)}·px² + ${b.toFixed(4)}·px + ${c.toFixed(2)} (H₂ auto)`;
  log(`Auto-Cal (H₂): px [${x1}, ${x2}, ${x3}] → λ [434, 486.1, 656.3] nm`);
};

// Auto-Cal (Rough)
$('#autoRough').onclick=()=>{
  const Y=getProfile().L;
  const found=findLocalPeaks(Y,{relProm:0.04});
  if(found.length<1){ log('Auto-Cal (Rough): no peaks — enlarge ROI / brighten.'); return; }
  found.sort((a,b)=>a.idx-b.idx);
  const left=found[0], right=found[found.length-1];
  let x1=0, x2=roi.w-1, y1=450, y2=650;
  if (right.idx - left.idx >= Math.max(40, roi.w*0.25)){ x1=left.idx; x2=right.idx; }
  const A=(y2-y1)/(x2-x1), B=y1 - A*x1;
  calib={kind:'linear',A,B}; calibrated=true;
  $('#eq2').textContent=`λ = ${A.toFixed(4)}·px + ${B.toFixed(2)} (rough)`;
  log(`Auto-Cal (Rough): px [${x1}, ${x2}] → λ ~[450,650] nm`);
};

// Hydrogen Quick-Cal wizard
const HQ = {active:false, stage:0};
const H_LINES = [434.0, 486.1, 656.3];
function startHydrogenQuickCal(){
  $('#wiz').style.display='flex';
  $('#wizMsg').innerHTML='Step 1 of 3 — On the graph, click <b>H-γ (434.0 nm)</b> (violet).';
  HQ.active=true; HQ.stage=0; log('Hydrogen Quick-Cal started.');
}
function cancelHydrogenQuickCal(){ HQ.active=false; $('#wiz').style.display='none'; log('Hydrogen Quick-Cal cancelled.'); }
function finishHydrogenQuickCal(){
  const x=[0,1,2].map(i=>picksPx[i]); if(x.some(v=>v==null)){ log('Quick-Cal: missing a click; retry.'); return; }
  const y=[H_LINES[0],H_LINES[1],H_LINES[2]];
  const [x1,x2,x3]=x,[y1,y2,y3]=y; const D=(x1-x2)*(x1-x3)*(x2-x3);
  const a=(x3*(y2-y1)+x2*(y1-y3)+x1*(y3-y2))/D;
  const b=(x3*x3*(y1-y2)+x2*x2*(y3-y1)+x1*x1*(y2-y3))/D;
  const c=(x2*x3*(x2-x3)*y1 + x3*x1*(x3-x1)*y2 + x1*x2*(x1-x2)*y3)/D;
  calibrated=true; calib.kind='quad'; calib.a=a; calib.b=b; calib.c=c;
  $('#eq3').textContent=`λ = ${a.toExponential(3)}·px² + ${b.toFixed(4)}·px + ${c.toFixed(2)}  (H Quick-Cal)`;
  $('#wiz').style.display='none'; HQ.active=false; log('Hydrogen Quick-Cal complete.');
}
$('#quickH').onclick = startHydrogenQuickCal;
$('#wizCancel').onclick = cancelHydrogenQuickCal;

// ---------- AUTO-SCALE / UTIL ----------
function percentile(arr, q){
  if (!arr.length) return 1;
  const step = Math.ceil(arr.length / 2000);
  const samp = [];
  for (let i=0;i<arr.length;i+=step) samp.push(arr[i]);
  samp.sort((a,b)=>a-b);
  const idx = Math.min(samp.length-1, Math.max(0, Math.floor(q*(samp.length-1))));
  return samp[idx] || 1;
}

let peaks=[];
$('#findPeaks').onclick=()=>{
  const Y=getProfile().L;
  const found=findLocalPeaks(Y,{relProm:0.04});
  const N=Math.max(1, Math.min(10, parseInt($('#topN').value,10)||5));
  peaks = found.slice(0,N).map(p=>{
    const lam = pxToNm(p.idx);
    return {idx:p.idx, amp:p.amp, lam, color:spectrumColor(lam)};
  });
  const leg=$('#legend'); leg.innerHTML='';
  for(const p of peaks){
    const item=document.createElement('div'); item.className='legend-item';
    const sw=document.createElement('span'); sw.className='sw'; sw.style.background=p.color;
    const lbl=document.createElement('span');
    lbl.textContent = isFinite(p.lam) ? `${p.lam.toFixed(1)} nm (px ${p.idx})` : `px ${p.idx}`;
    item.append(sw,lbl); leg.appendChild(item);
  }
  log('Find Peaks: '+peaks.length);
};

// ---------- DRAW LOOP ----------
let bgProfile=null;
function drawPlot(){
  // preview + ROI
  if(vid.readyState>=2){
    ctxD.drawImage(vid,0,0,draw.width,draw.height);
    ctxD.strokeStyle='rgba(88,166,255,.9)'; ctxD.lineWidth=2;
    ctxD.strokeRect(roi.x,roi.y,roi.w,roi.h);
  }

  const P=getProfile();
  if($('#bg').checked && !bgProfile) bgProfile=P;
  const m=$('#mode').value;
  const Yraw = m==='r'?P.R: m==='g'?P.G: m==='b'?P.B: P.L;
  const Yb = ($('#bg').checked && bgProfile)
    ? Yraw.map((v,i)=>Math.max(0, v - bgProfile[m==='r'?'R':m==='g'?'G':m==='b'?'B':'L'][i]))
    : Yraw;

  plot.width = plot.clientWidth; plot.height = plot.clientHeight;
  const Wp=plot.width, Hp=plot.height;
  ctxP.fillStyle='#000'; ctxP.fillRect(0,0,Wp,Hp);

  // axes (nm if calibrated; else px)
  ctxP.font='18px ui-monospace,Consolas,Menlo';
  ctxP.fillStyle='#cfd6de'; ctxP.strokeStyle='#333'; ctxP.lineWidth=1;

  if (calibrated){
    const VIS_MIN=380, VIS_MAX=780, step=50;
    for(let lam=VIS_MIN; lam<=VIS_MAX; lam+=step){
      const px = nmToPx(lam);
      if(!isFinite(px)) continue;
      const x = (px/roi.w)*Wp;
      if (x<0 || x>Wp) continue;
      ctxP.beginPath(); ctxP.moveTo(x,0); ctxP.lineTo(x,Hp); ctxP.stroke();
      ctxP.fillText(`${lam} nm`, x+4, 22);
    }
    ctxP.fillText('Wavelength (nm)', 10, Hp-10);
  } else {
    const stepPx=Math.max(20,Math.round(roi.w/5));
    for(let p=0;p<=roi.w;p+=stepPx){
      const x=(p/roi.w)*Wp;
      ctxP.beginPath(); ctxP.moveTo(x,0); ctxP.lineTo(x,Hp); ctxP.stroke();
      ctxP.fillText(`${p} px`, x+4, 22);
    }
    ctxP.fillText('Pixel (uncalibrated)', 10, Hp-10);
  }

  // Y label
  ctxP.save(); ctxP.rotate(-Math.PI/2);
  ctxP.fillText('Relative intensity (a.u.)', -Hp+10, 16);
  ctxP.restore();

  // --- sensor clip detection using raw preview ROI ---
  let clip = false;
  {
    const sx = mirrorX ? (draw.width - roi.x - roi.w) : roi.x;
    const data = ctxD.getImageData(Math.round(sx), Math.round(roi.y), Math.round(roi.w), Math.max(1,Math.round(roi.h))).data;
    let sat = 0, total = data.length/4;
    for (let i=0;i<data.length;i+=4){
      if (data[i] >= 254 || data[i+1] >= 254 || data[i+2] >= 254) sat++;
    }
    clip = (sat/Math.max(1,total)) > 0.015; // >1.5% pixels saturated
    $('#clipWarn').style.display = clip ? 'inline' : 'none';
  }

  // --- robust auto-scale (p99.9) + optional log scale ---
  const useAuto = $('#autoY')?.checked;
  const useLog  = $('#logY')?.checked;

  let scaleMax;
  if (useAuto) {
    const p999 = percentile(Yb, 0.999);
    scaleMax = clip ? Math.max(p999 * 0.75, 1e-6) : Math.max(p999, 1e-6);
  } else {
    scaleMax = Math.max(...Yb) || 1;
  }

  // plot curve
  ctxP.strokeStyle='#58a6ff'; ctxP.lineWidth=2; ctxP.beginPath();
  for(let i=0;i<Yb.length;i++){
    const val = useLog ? Math.log10(1 + 9*(Yb[i]/(scaleMax||1))) : (Yb[i]/(scaleMax||1));
    const x = (i/roi.w)*Wp;
    const y = Hp - Math.min(1,val) * (Hp - 70) - 20;
    if(i===0) ctxP.moveTo(x,y); else ctxP.lineTo(x,y);
  }
  ctxP.stroke();

  // peak markers
  if (peaks.length){
    for(const pk of peaks){
      const x = (pk.idx/roi.w)*Wp;
      ctxP.strokeStyle = pk.color; ctxP.lineWidth = 2;
      ctxP.beginPath(); ctxP.moveTo(x,0); ctxP.lineTo(x,Hp); ctxP.stroke();

      const txt = isFinite(pk.lam) ? `${pk.lam.toFixed(1)} nm` : `px ${pk.idx}`;
      const pad=4; const w=ctxP.measureText(txt).width+pad*2;
      ctxP.fillStyle='rgba(15,20,27,0.9)'; ctxP.fillRect(x+4,6,w,20);
      ctxP.strokeStyle='#2a2f35'; ctxP.lineWidth=1; ctxP.strokeRect(x+4,6,w,20);
      ctxP.fillStyle=pk.color; ctxP.fillText(txt,x+4+pad,21);

      const val = useLog ? Math.log10(1 + 9*((pk.amp||scaleMax)/(scaleMax||1))) : ((pk.amp||scaleMax)/(scaleMax||1));
      const y = Hp - Math.min(1,val) * (Hp - 70) - 20;
      ctxP.beginPath(); ctxP.arc(x,y,3,0,Math.PI*2); ctxP.fill();
    }
  }

  requestAnimationFrame(drawPlot);
}
function loop(){ requestAnimationFrame(loop); }
requestAnimationFrame(drawPlot);

// SNAPSHOT / CSV
$('#snap').onclick=()=>{
  const c=document.createElement('canvas'); c.width=draw.width; c.height=draw.height;
  c.getContext('2d').drawImage(draw,0,0);
  const a=document.createElement('a'); a.download='spectrum.png'; a.href=c.toDataURL('image/png'); a.click();
};
$('#csv').onclick=()=>{
  const P=getProfile(); const Y=P.L;
  let rows = calibrated ? 'px_roi,lambda_nm,intensity\n' : 'px_roi,intensity\n';
  for(let i=0;i<Y.length;i++){
    const lam = pxToNm(i);
    rows += calibrated ? `${i},${isFinite(lam)?lam.toFixed(3):''},${Y[i].toFixed(6)}\n`
                       : `${i},${Y[i].toFixed(6)}\n`;
  }
  const blob=new Blob([rows],{type:'text/csv'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='spectrum.csv'; a.click();
};
</script>
</body>
</html>
