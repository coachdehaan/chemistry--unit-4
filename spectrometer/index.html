<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Webcam Spectrometer – Hybrid Stable</title>
<style>
  :root{--bg:#0d1117;--ink:#e6edf3;--mut:#9aa4ad;--acc:#58a6ff;--grid:#30363d}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:10px 14px;border-bottom:1px solid var(--grid);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0 8px 0 0}
  .warn{background:#331;color:#f6d7d7;padding:4px 8px;border-radius:8px;border:1px solid #633}
  main{display:grid;grid-template-columns:1.25fr 1fr;gap:10px;padding:10px}
  .panel{border:1px solid var(--grid);border-radius:10px;overflow:hidden;background:#0f141b}
  .p-h{padding:8px 10px;background:#0b0f14;border-bottom:1px solid var(--grid);font-weight:700}
  .p-b{padding:10px}
  video,canvas{max-width:100%;display:block}
  #viewwrap{position:relative;background:#000}
  #draw{position:absolute;inset:0;pointer-events:none}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0}
  label{color:var(--mut)}
  input,select,button{background:#0b0f14;color:var(--ink);border:1px solid var(--grid);border-radius:8px;padding:8px 10px}
  button{cursor:pointer}
  #plot{height:340px;width:100%;background:#000;border:1px solid var(--grid);border-radius:8px}
  #log{white-space:pre-wrap;background:#0b0f14;border:1px solid var(--grid);border-radius:8px;padding:8px;min-height:56px}
  .badge{background:#1f6feb;border:1px solid #2f81f7;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
  #legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .legend-item{display:flex;align-items:center;gap:6px;background:#0b0f14;border:1px solid #2a2f35;border-radius:8px;padding:4px 8px;font:14px ui-monospace,Consolas,Menlo}
  .swatch{width:12px;height:12px;border-radius:3px;border:1px solid #222}
</style>
</head>
<body>
<header>
  <h1>Webcam Spectrometer</h1>
  <span id="httpsWarn" class="warn" style="display:none">Not HTTPS. Use GitHub Pages (https://)</span>
</header>

<main>
  <section class="panel">
    <div class="p-h">Live Preview</div>
    <div class="p-b" id="viewwrap">
      <video id="vid" playsinline muted autoplay></video>
      <canvas id="draw"></canvas>
    </div>
    <div class="p-b">
      <div class="row">
        <button id="start">Start Camera</button>
        <label>Camera <select id="cams"></select></label>
        <label>Res <select id="res"><option selected>640x480</option><option>1280x720</option></select></label>
        <label>Avg rows <input id="avg" type="number" value="8" min="1" max="200" style="width:70px"></label>
        <label>Smooth <input id="smooth" type="number" value="2" min="1" max="25" style="width:60px"></label>
        <span id="fps" style="font-size:12px;color:#9aa4ad">FPS –</span>
      </div>
      <div class="row">
        <button id="qc">Quick Cal (Hg 546 → Na 589)</button>
        <button id="clearCal">Clear</button>
        <button id="findPeaks">Find Peaks</button>
        <span id="calState" class="badge">Uncalibrated</span>
      </div>
      <div id="log" class="small"></div>
    </div>
  </section>

  <section class="panel">
    <div class="p-h">Spectrum</div>
    <div class="p-b">
      <canvas id="plot"></canvas>
      <div id="legend"></div>
    </div>
  </section>
</main>

<script>
const $=s=>document.querySelector(s);
const vid=$('#vid'),draw=$('#draw'),plot=$('#plot');
const ctxD=draw.getContext('2d',{willReadFrequently:true});
const ctxP=plot.getContext('2d',{willReadFrequently:true});
const log=m=>{$('#log').textContent+=($('#log').textContent?'\n':'')+m;console.log(m)};
if(!window.isSecureContext)$('#httpsWarn').style.display='inline-block';
let stream=null,roi={y:220,h:44},calib={A:NaN,B:NaN},peaks=[],qcStage=0,W=640,H=480;
const colors=['#ff4d4d','#2ecc71','#3498db','#f1c40f','#9b59b6','#e67e22','#1abc9c','#e84393'];

function fit(){draw.width=vid.videoWidth||W;draw.height=vid.videoHeight||H;
plot.width=plot.clientWidth;plot.height=340;
ctxP.fillStyle='#000';ctxP.fillRect(0,0,plot.width,plot.height);
ctxP.fillStyle='#c9d1d9';ctxP.font='16px ui-monospace';ctxP.fillText('Start Camera → Quick Cal → Find Peaks',12,26);}
window.onresize=fit;

async function enumerate(){const devs=await navigator.mediaDevices.enumerateDevices();
const cams=devs.filter(d=>d.kind==='videoinput');const sel=$('#cams');sel.innerHTML='';
cams.forEach((d,i)=>{const o=document.createElement('option');o.value=d.deviceId;o.textContent=d.label||'Cam '+(i+1);sel.appendChild(o);});}
function makeC(id){const[w,h]=$('#res').value.split('x').map(Number);
return id?{video:{deviceId:{exact:id},width:{ideal:w},height:{ideal:h}},audio:false}:{video:{width:{ideal:w},height:{ideal:h}},audio:false};}
async function startCam(){
$('#log').textContent='';
if(!window.isSecureContext){log('ERROR – needs HTTPS');return;}
if(stream){stream.getTracks().forEach(t=>t.stop());}
await enumerate();const id=$('#cams').value;
try{stream=await navigator.mediaDevices.getUserMedia(makeC(id));}catch(e){log(e);return;}
vid.srcObject=stream;await vid.play();await new Promise(r=>vid.onloadedmetadata=r);
W=vid.videoWidth;H=vid.videoHeight;fit();requestAnimationFrame(loop);
log('Camera started');}
$('#start').onclick=startCam;

function getProfile(){
const avg=parseInt($('#avg').value)||8;const y0=Math.max(0,roi.y);
const data=ctxD.getImageData(0,y0,draw.width,avg).data;
const R=new Float32Array(draw.width),G=new Float32Array(draw.width),B=new Float32Array(draw.width);
for(let r=0;r<avg;r++){for(let x=0;x<draw.width;x++){const i=(r*draw.width+x)*4;R[x]+=data[i];G[x]+=data[i+1];B[x]+=data[i+2];}}
for(let x=0;x<draw.width;x++){R[x]/=avg;G[x]/=avg;B[x]/=avg;}
const L=new Float32Array(draw.width);
for(let x=0;x<draw.width;x++){L[x]=0.2126*R[x]+0.7152*G[x]+0.0722*B[x];}
return {R,G,B,L};}
function pxToNm(px){return isFinite(calib.A)?calib.A*px+calib.B:NaN;}
function nmToPx(nm){return isFinite(calib.A)?(nm-calib.B)/calib.A:NaN;}
function findPeaks(Y){
const out=[],N=Y.length,maxY=Math.max(...Y)||1,th=0.18*maxY,minD=Math.floor(N/80);
for(let i=1;i<N-1;i++){if(Y[i]>th&&Y[i]>Y[i-1]&&Y[i]>Y[i+1]){if(out.length&&(i-out
