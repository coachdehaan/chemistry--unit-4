<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Balance the Ecosystem - Interactive Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#ffffff; --ink:#1f2937; --muted:#6b7280; --panel:#f8fafc; --border:#e5e7eb; --accent:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;line-height:1.35}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{font-size:1.75rem;margin:0 0 4px}
    .sub{color:var(--muted);font-size:.95rem;margin-bottom:16px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:12px;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    button:hover{background:#f3f4f6}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:940px){.grid{grid-template-columns: 360px 1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
    .label{font-weight:600;margin-bottom:8px}
    .row{display:flex;align-items:center;gap:10px;margin:8px 0}
    .row .name{width:210px;font-size:.9rem}
    .row input[type=range]{flex:1}
    .value{width:64px;text-align:right;font-variant-numeric:tabular-nums;font-size:.8rem;color:var(--muted)}
    .presets{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .muted{color:var(--muted);font-size:.85rem}
    .kpi{display:flex;align-items:center;gap:10px}
    .bar{flex:1;height:12px;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#fff}
    .bar > div{height:100%;background:var(--accent);transition:width .2s ease}
    .small{font-size:.8rem;color:var(--muted)}
    .cols-3{display:grid;gap:12px}
    @media(min-width:900px){.cols-3{grid-template-columns: repeat(3, 1fr)}}
    .list{margin:0;padding-left:18px}
    /* ensure a visible chart height on Pages */
    #chart{height:360px !important}
    .code{font-family:ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;font-size:.78rem}
    #scene{display:block;width:100%;height:220px;border:1px solid var(--border);border-radius:12px;background:#fff}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Balance the Ecosystem</h1>
      <div class="sub">Adjust resources and human impact. Observe prey-predator dynamics and ecosystem health.</div>
      <div class="toolbar">
        <button id="startPauseBtn">Start</button>
        <button id="stepBtn">Step</button>
        <button id="resetBtn">Reset</button>
      </div>
    </header>

    <main class="grid">
      <!-- Controls -->
      <section class="card">
        <div class="label">Controls</div>

        <div class="row">
          <div class="name">Sunlight (resource)</div>
          <input id="sunlight" type="range" min="0" max="100" step="1" value="80">
          <div class="value" id="sunlightVal">80</div>
        </div>

        <div class="row">
          <div class="name">Water (resource)</div>
          <input id="water" type="range" min="0" max="100" step="1" value="70">
          <div class="value" id="waterVal">70</div>
        </div>

        <div class="row">
          <div class="name">Pollution (human impact)</div>
          <input id="pollution" type="range" min="0" max="100" step="1" value="5">
          <div class="value" id="pollutionVal">5</div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">

        <div class="row">
          <div class="name">Prey initial (reset)</div>
          <input id="prey0" type="range" min="0" max="200" step="1" value="60">
          <div class="value" id="prey0Val">60</div>
        </div>

        <div class="row">
          <div class="name">Predator initial (reset)</div>
          <input id="pred0" type="range" min="0" max="200" step="1" value="18">
          <div class="value" id="pred0Val">18</div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">

        <div class="row">
          <div class="name">Sim speed (ms/step)</div>
          <input id="speed" type="range" min="40" max="400" step="10" value="120">
          <div class="value" id="speedVal">120</div>
        </div>

        <div class="presets" id="presets"></div>

        <div class="muted" style="margin-top:10px">
          <div><strong>Model:</strong> logistic prey plus predation with environmental modifiers.</div>
          <div><strong>Teaching idea:</strong> Start balanced, raise pollution, discuss carrying capacity (K) and density dependence.</div>
        </div>
      </section>

      <!-- Charts and Health -->
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="label" style="margin:0">Populations over Time</div>
          <div class="small">t = <span id="tval">0.0</span> | K_eff approx <span id="keff">-</span></div>
        </div>
        <canvas id="chart" aria-label="Prey and predator populations over time"></canvas>
<div class="card" style="margin-top:12px">
  <div class="label" style="margin:0 0 6px">Ecosystem Scene (Animated)</div>
  <canvas id="scene" aria-label="Animated ecosystem scene"></canvas>
  <div class="small">Sky haze rises with pollution; grass height follows K_eff; colors fade as health drops. Dots = prey, triangles = predators.</div>
</div>

        <div class="kpi" style="margin-top:12px">
          <div class="label" style="margin:0">Ecosystem Health</div>
          <div class="bar"><div id="healthFill" style="width:0%"></div></div>
          <div class="small"><span id="healthText">0</span>/100</div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="label" style="margin:0 0 6px">Guided Prompts</div>
          <ul class="list">
            <li>Increase pollution to 60. What happens to predators first? Why?</li>
            <li>Lower water to 20. Watch K_eff. How does prey respond compared to predators?</li>
            <li>Use "Overhunting Predators", then restore predators. How does the system recover?</li>
          </ul>
        </div>
      </section>
    </main>

    <!-- Reference -->
    <section class="cols-3" style="margin-top:16px">
      <div class="card">
        <div class="label">Equation Reference</div>
        <div class="code">prey(t+dt) = prey + [ r*s*prey*(1 - prey/K_eff) - a*pred*prey ] * dt</div>
        <div class="code">pred(t+dt) = pred + [ b*a*pred*prey - ( m + polMort )*pred ] * dt</div>
      </div>
      <div class="card">
        <div class="label">Variables</div>
        <div class="small">
          r: prey growth, a: predation, b: conversion, m: mortality,<br>
          K_eff: carrying capacity, s: prey stress factor
        </div>
      </div>
      <div class="card">
        <div class="label">Faith and Stewardship (optional)</div>
        <div class="small"><em>"The earth is the LORD's" (Ps 24:1)</em> â€” wise choices (lower pollution, restore predators) reflect stewardship.</div>
      </div>
    </section>
  </div>

  <script>
    // Utility
    function clamp(x, lo, hi){ lo = (lo===undefined?0:lo); hi = (hi===undefined?1e9:hi); return Math.max(lo, Math.min(hi, x)); }

    // Parameters and State
    var sunlight = 80, water = 70, pollution = 5;
    var prey = 60, pred = 18;
    var dt = 0.1, r = 0.7, a = 0.004, b = 0.12, m = 0.22, K_base = 220;
    var time = 0, timer = null, speedMs = 120;
    var MAX_POINTS = 360;

    // DOM
    function el(id){ return document.getElementById(id); }
    var inputs = { sunlight: el('sunlight'), water: el('water'), pollution: el('pollution'), prey0: el('prey0'), pred0: el('pred0'), speed: el('speed') };
    var vals = { sunlight: el('sunlightVal'), water: el('waterVal'), pollution: el('pollutionVal'), prey0: el('prey0Val'), pred0: el('pred0Val'), speed: el('speedVal'), tval: el('tval'), keff: el('keff'), healthText: el('healthText'), healthFill: el('healthFill') };
    var startPauseBtn = el('startPauseBtn'), stepBtn = el('stepBtn'), resetBtn = el('resetBtn'), presetsWrap = el('presets');

    // Scenarios
    var SCENARIOS = [
      { name: 'Balanced Prairie',      params: { sunlight:80, water:70, pollution:5,  prey0:60, pred0:18 }},
      { name: 'Drought Year',          params: { sunlight:85, water:25, pollution:10, prey0:40, pred0:12 }},
      { name: 'Runoff and Pollution',  params: { sunlight:70, water:75, pollution:45, prey0:55, pred0:15 }},
      { name: 'Overhunting Predators', params: { sunlight:80, water:70, pollution:5,  prey0:60, pred0:6  }}
    ];
    SCENARIOS.forEach(function(s){
      var b = document.createElement('button');
      b.textContent = s.name;
      b.addEventListener('click', function(){ reset(s.params); });
      presetsWrap.appendChild(b);
    });

    // Chart with explicit colors
    var ctx = el('chart').getContext('2d');
    var chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          { label: 'Prey',      data: [], borderWidth: 2, pointRadius: 0, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.15)' },
          { label: 'Predators', data: [], borderWidth: 2, pointRadius: 0, borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.15)' },
          { label: 'K_eff',     data: [], borderWidth: 1.5, pointRadius: 0, borderDash: [5,5], borderColor: '#6b7280', backgroundColor: 'rgba(107,114,128,0.10)' }
        ]
      },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { type: 'linear', title: { display:true, text:'time' }, ticks: { maxTicksLimit: 8 } },
          y: { beginAtZero: true }
        },
        plugins: {
          legend: { labels: { boxWidth: 12 } },
          tooltip: { mode: 'nearest', intersect: false }
        },
        elements: { line: { tension: 0.25 } }
      }
    });

    function pushPoint(t, preyVal, predVal, kEff){
      function push(ds, x, y){ ds.data.push({ x:x, y:y }); if (ds.data.length > MAX_POINTS) ds.data.shift(); }
      push(chart.data.datasets[0], t, preyVal);
      push(chart.data.datasets[1], t, predVal);
      push(chart.data.datasets[2], t, kEff);
      chart.update();
    }
    function clearChart(){ chart.data.datasets.forEach(function(d){ d.data = []; }); chart.update(); }

    // Environment and Health
    function envModifiers(){
      var resFactor = (0.35 + 0.65*(sunlight/100) * (0.6 + 0.4*(water/100)));
      var polFactor = 1 - 0.7*(pollution/100);
      var K_eff = clamp(K_base * resFactor * polFactor, 30, 600);
      var polMort = 0.15*(pollution/100);
      var preyStress = 1 - 0.25*(pollution/100);
      return { K_eff:K_eff, polMort:polMort, preyStress:preyStress };
    }
    function healthIndex(K_eff){
      var diversity = Math.max(0, 1 - Math.abs(prey - pred)/(prey + pred + 1));
      var headroom = Math.max(0, 1 - Math.max(0, (prey - K_eff))/K_eff);
      var pol = 1 - (pollution/100);
      var raw = 100 * (0.45*diversity + 0.35*headroom + 0.20*pol);
      return clamp(raw, 0, 100);
    }

    // Simulation
    function step(){
      var env = envModifiers();
      var dPrey = (r * env.preyStress) * prey * (1 - prey/env.K_eff) - a * pred * prey;
      var dPred = b * a * pred * prey - (m + env.polMort) * pred;
      prey = clamp(prey + dPrey * dt, 0, 5000);
      pred = clamp(pred + dPred * dt, 0, 5000);
      time = +(time + dt).toFixed(1);

      var H = healthIndex(env.K_eff);
      el('tval').textContent = time.toFixed(1);
      el('keff').textContent = env.K_eff.toFixed(0);
      el('healthText').textContent = Math.round(H);
      el('healthFill').style.width = H + '%';

      pushPoint(time, +prey.toFixed(1), +pred.toFixed(1), +env.K_eff.toFixed(1));
    }

    // Wiring
    function wireSlider(key, setter){
      inputs[key].addEventListener('input', function(e){
        var v = Number(e.target.value);
        vals[key].textContent = v;
        setter(v);
      });
    }
    wireSlider('sunlight', function(v){ sunlight = v; });
    wireSlider('water',    function(v){ water = v; });
    wireSlider('pollution',function(v){ pollution = v; });
    wireSlider('prey0',    function(v){ prey = v; });
    wireSlider('pred0',    function(v){ pred = v; });
    wireSlider('speed',    function(v){ speedMs = v; if (timer){ clearInterval(timer); timer = setInterval(step, speedMs); }});

    startPauseBtn.addEventListener('click', function(){
      if (timer){ clearInterval(timer); timer = null; startPauseBtn.textContent = 'Start'; }
      else { timer = setInterval(step, speedMs); startPauseBtn.textContent = 'Pause'; }
    });
    stepBtn.addEventListener('click', step);
    resetBtn.addEventListener('click', function(){ reset(); });

    function reset(preset){
      sunlight = (preset && preset.sunlight!=null)? preset.sunlight : Number(inputs.sunlight.value);
      water    = (preset && preset.water!=null)?    preset.water    : Number(inputs.water.value);
      pollution= (preset && preset.pollution!=null)?preset.pollution: Number(inputs.pollution.value);
      prey     = (preset && preset.prey0!=null)?    preset.prey0    : Number(inputs.prey0.value);
      pred     = (preset && preset.pred0!=null)?    preset.pred0    : Number(inputs.pred0.value);

      if (preset){
        inputs.sunlight.value = sunlight; vals.sunlight.textContent = sunlight;
        inputs.water.value = water;       vals.water.textContent = water;
        inputs.pollution.value = pollution; vals.pollution.textContent = pollution;
        inputs.prey0.value = prey;        vals.prey0.textContent = prey;
        inputs.pred0.value = pred;        vals.pred0.textContent = pred;
      }

      time = 0;
      el('tval').textContent = '0.0';
      clearChart();
      var env = envModifiers();
      el('keff').textContent = env.K_eff.toFixed(0);
      var H = healthIndex(env.K_eff);
      el('healthText').textContent = Math.round(H);
      el('healthFill').style.width = H + '%';
    }
// ------- Ecosystem Scene (Canvas) -------
var scene = el('scene');
var sctx = scene.getContext('2d');
function sizeScene(){ scene.width = scene.clientWidth; scene.height = scene.clientHeight; }
window.addEventListener('resize', sizeScene); sizeScene();

var preySprites = [], predSprites = [];
var MAX_SPRITES = 60;            // total sprites for each species (visual cap)
var PREY_COL = '#2563eb';        // matches chart colors
var PRED_COL = '#dc2626';

function rand(a,b){ return a + Math.random()*(b-a); }
function spawn(list, n){
  for(let i=0;i<n;i++){
    list.push({
      x: rand(10, scene.width-10),
      y: rand(10, scene.height-30),
      vx: rand(-0.6,0.6),
      vy: rand(-0.6,0.6)
    });
  }
}
function trim(list, n){ while(list.length>n) list.pop(); }

function healthNow(K){ 
  // same ingredients as your healthIndex but cheap (no rounding)
  var diversity = Math.max(0, 1 - Math.abs(prey - pred)/(prey + pred + 1));
  var headroom = Math.max(0, 1 - Math.max(0, (prey - K))/K);
  var pol = 1 - (pollution/100);
  var raw = 100 * (0.45*diversity + 0.35*headroom + 0.20*pol);
  return Math.max(0, Math.min(100, raw));
}

// squashes population to 0..MAX_SPRITES smoothly
function popToSprites(pop){ return Math.max(0, Math.min(MAX_SPRITES, Math.round(MAX_SPRITES*(1 - Math.exp(-pop/60))))); }

function wrap(p){
  if(p.x<0) p.x+=scene.width; if(p.x>scene.width) p.x-=scene.width;
  if(p.y<0) p.y+=scene.height; if(p.y>scene.height) p.y-=scene.height;
}
function stepSprites(){
  // simple chase/evade: preds drift toward nearby prey; prey drift away
  for(const pr of predSprites){
    // find nearest prey
    let best=null, bd2=1e9;
    for(const py of preySprites){
      const dx=py.x-pr.x, dy=py.y-pr.y, d2=dx*dx+dy*dy;
      if(d2<bd2){ bd2=d2; best=py; }
    }
    if(best){
      const dx=best.x-pr.x, dy=best.y-pr.y, d=Math.sqrt(dx*dx+dy*dy)+1e-6;
      pr.vx += 0.02*(dx/d);
      pr.vy += 0.02*(dy/d);
    }
    pr.vx *= 0.98; pr.vy *= 0.98;
    pr.x += pr.vx; pr.y += pr.vy;
    wrap(pr);
  }
  for(const py of preySprites){
    // flee nearest predator
    let best=null, bd2=1e9;
    for(const pr of predSprites){
      const dx=pr.x-py.x, dy=pr.y-py.y, d2=dx*dx+dy*dy;
      if(d2<bd2){ bd2=d2; best=pr; }
    }
    if(best){
      const dx=py.x-best.x, dy=py.y-best.y, d=Math.sqrt(dx*dx+dy*dy)+1e-6;
      py.vx += 0.025*(dx/d);
      py.vy += 0.025*(dy/d);
    } else {
      // gentle wander
      py.vx += rand(-0.01,0.01);
      py.vy += rand(-0.01,0.01);
    }
    // clamp speed
    const sp = Math.hypot(py.vx, py.vy); if(sp>1.0){ py.vx*=0.98; py.vy*=0.98; }
    py.x += py.vx; py.y += py.vy;
    wrap(py);
  }
}

function drawTriangle(x,y,ang,size){
  sctx.beginPath();
  sctx.moveTo(x + Math.cos(ang)*size, y + Math.sin(ang)*size);
  sctx.lineTo(x + Math.cos(ang+2.5)*size*0.9, y + Math.sin(ang+2.5)*size*0.9);
  sctx.lineTo(x + Math.cos(ang-2.5)*size*0.9, y + Math.sin(ang-2.5)*size*0.9);
  sctx.closePath();
  sctx.fill();
}

function renderScene(){
  const env = envModifiers();
  const H = healthNow(env.K_eff);       // 0..100
  const haze = pollution/100;           // 0..1
  const grassH = Math.max(8, 60 * (env.K_eff / (K_base)));   // grass height

  // background: sky -> ground
  const w=scene.width, h=scene.height, groundY=h-28;
  const skyTop = `rgba(${Math.round(220*(1-haze))},${Math.round(235*(1-haze))},255,1)`;
  const skyBot = `rgba(${Math.round(180*(1-haze))},${Math.round(210*(1-haze))},240,1)`;
  const grad = sctx.createLinearGradient(0,0,0,groundY);
  grad.addColorStop(0, skyTop); grad.addColorStop(1, skyBot);
  sctx.fillStyle = grad; sctx.fillRect(0,0,w,groundY);

  // haze overlay
  sctx.fillStyle = `rgba(120,120,120,${0.18*haze})`;
  sctx.fillRect(0,0,w,groundY);

  // ground (greener with health)
  const gSat = 0.35 + 0.65*(H/100);
  sctx.fillStyle = `rgba(${Math.round(40+60*gSat)},${Math.round(120+90*gSat)},${Math.round(40)},1)`;
  sctx.fillRect(0,groundY,w,28);

  // grass blades (height ~ K_eff)
  sctx.strokeStyle = sctx.fillStyle; sctx.lineWidth = 1;
  for(let x=0; x<w; x+=6){
    sctx.beginPath();
    sctx.moveTo(x,groundY+2);
    sctx.lineTo(x,groundY - grassH*0.3 - rand(-2,2));
    sctx.stroke();
  }

  // sprites
  sctx.globalAlpha = 0.8;
  // prey = circles
  sctx.fillStyle = PREY_COL;
  for(const p of preySprites){
    sctx.beginPath(); sctx.arc(p.x,p.y,3.2,0,Math.PI*2); sctx.fill();
  }
  // predators = triangles pointing along velocity
  sctx.fillStyle = PRED_COL;
  for(const p of predSprites){
    const ang = Math.atan2(p.vy, p.vx) || 0;
    drawTriangle(p.x,p.y,ang,4.5);
  }
  sctx.globalAlpha = 1;
}

function syncSpriteCounts(){
  const env = envModifiers();
  const targetPrey = popToSprites(prey);
  const targetPred = popToSprites(pred);
  if(preySprites.length < targetPrey) spawn(preySprites, targetPrey - preySprites.length);
  if(predSprites.length < targetPred) spawn(predSprites, targetPred - predSprites.length);
  trim(preySprites, targetPrey);
  trim(predSprites, targetPred);
}

function animate(){
  // gently resync counts (in case populations changed)
  syncSpriteCounts();
  stepSprites();
  renderScene();
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

    // Init
    reset({ sunlight:80, water:70, pollution:5, prey0:60, pred0:18 });
  </script>
</body>
</html>
