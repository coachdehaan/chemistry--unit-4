<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presentation — Live Class Rater</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;line-height:1.35;background:#f7f7f7}
    .wrap{max-width:1000px;margin:0 auto}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:14px 16px}
    .btn{padding:.5rem 1rem;border-radius:.75rem;border:1px solid #111;background:#111;color:#fff;font-weight:600}
    .btn-ghost{padding:.35rem .65rem;border-radius:.65rem;border:1px solid #ddd;background:#fff}
    .badge{font-size:.7rem;padding:.2rem .5rem;border-radius:9999px;background:#eef}
    input[type="range"]{width:100%}
    .mut{color:#666;font-size:12px}
    .tiny{font-size:11px;line-height:1.2}
  </style>

  <!-- Firebase SDKs -->
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h1 style="margin:0">Presentation — Live Class Rater</h1>
      <div style="display:flex;align-items:center;gap:8px">
        <span id="connectionBadge" class="badge">offline (local)</span>
        <button id="loginBtn" class="btn-ghost" title="Teacher login">Login</button>
      </div>
    </header>

    <div class="row">
      <!-- LEFT: Student join + sliders -->
      <section style="display:flex;flex-direction:column;gap:12px">
        <div id="joinCard" class="card">
          <h3 style="margin:0 0 8px 0">Join</h3>
          <label class="mut">Your name</label>
          <input id="nameInput" style="width:100%;padding:.6rem;border:1px solid #ccc;border-radius:10px" placeholder="e.g., Jane S." />
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button id="joinBtn" class="btn">Join & Rate</button>
            <span id="joinStatus" class="mut"></span>
          </div>
        </div>

        <div id="rateCard" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Rate (1–10)</h3>
            <div class="mut">You: <span id="whoami" style="font-weight:600">—</span></div>
          </div>
          <div id="criteriaList" style="margin-top:10px;display:flex;flex-direction:column;gap:12px"></div>
          <div style="margin-top:10px;display:flex;justify-content:flex-end;align-items:center">
            <div class="mut">Totals update as you slide.</div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Results (teacher PIN) -->
      <aside id="resultsCard" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <h3 style="margin:0">Results (Live)</h3>
          <span id="participantsBadge" class="badge">0 participants</span>
        </div>

        <div id="resultsSummary" style="display:flex;flex-direction:column;gap:6px"></div>

        <div style="border-top:1px solid #eee;margin-top:10px;padding-top:8px" class="tiny">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Final average</strong> (by category)</div>
            <div style="font-weight:700;font-size:18px" id="finalAverage">0.00</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
            <div>Class total average</div>
            <div id="classTotalAvg" style="font-weight:600">0.00</div>
          </div>
          <div class="mut tiny">Max total = <span id="maxTotal"></span></div>
        </div>

        <div style="margin-top:10px">
          <div class="tiny" style="font-weight:700;margin-bottom:4px">Participants</div>
          <div id="participantsList" class="tiny" style="color:#333"></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="resetSession" class="btn-ghost" title="Kick everyone and clear scores">Reset Session</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Teacher login modal -->
  <dialog id="loginDlg" style="border:none;border-radius:12px;max-width:380px;width:92%">
    <form method="dialog" style="padding:16px">
      <h3 style="margin:0 0 8px 0">Teacher Login</h3>
      <p class="mut tiny" style="margin-top:0">Enter PIN to unlock the Results panel.</p>
      <input id="pinInput" type="password" style="width:100%;padding:.6rem;border:1px solid #ccc;border-radius:10px" placeholder="PIN" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="unlockBtn" class="btn" value="unlock">Unlock</button>
        <button class="btn-ghost" value="cancel">Close</button>
      </div>
    </form>
  </dialog>

  <script>
    // ===== CONFIG =====
    const CONFIG = {
      classKey: "chem_presentation",
      teacherPin: "2468",
      useFirebase: true,
      firebaseConfig: {
        apiKey: "AIzaSyAal8uHe9nePGimXiRPZAnBl0ucQlKnXNo",
        authDomain: "presentation-83d1f.firebaseapp.com",
        databaseURL: "https://presentation-83d1f-default-rtdb.firebaseio.com",
        projectId: "presentation-83d1f",
        storageBucket: "presentation-83d1f.firebasestorage.app",
        messagingSenderId: "132406143951",
        appId: "1:132406143951:web:9695690023bd3f2aedc0ba"
      },
      criteria: [
        { id: uid(), label: "Content Accuracy" },
        { id: uid(), label: "Clarity" },
        { id: uid(), label: "Visuals" },
        { id: uid(), label: "Engagement" },
        { id: uid(), label: "Delivery" }
      ]
    };
    const MAX_SCORE = 10;

    // ===== STATE =====
    const state = { db:null, me:{id:null,name:null}, online:false, studentRef:null };
    let cacheStudents = {};
    const basePath = () => `/classes/${CONFIG.classKey}`;

    // ===== UTIL =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function mean(a){ return a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0; }
    function show(el,on){ el.style.display = on ? '' : 'none'; }
    function badge(txt){ $('#connectionBadge').textContent = txt; }

    // ===== FIREBASE INIT =====
    function dbInit(){
      if(!CONFIG.useFirebase){ badge('offline (local)'); return; }
      try{
        firebase.initializeApp(CONFIG.firebaseConfig);
        state.db = firebase.database();
        firebase.auth().signInAnonymously().then(()=>{
          state.online = true; badge('online (firebase)');
          attachListeners();
        }).catch(()=>{ state.online=false; badge('offline (local)'); });
      }catch(e){ state.online=false; badge('offline (local)'); }
    }
    function attachListeners(){
      const cRef = state.db.ref(`${basePath()}/criteria`);
      cRef.once('value').then(s=>{ if(!s.exists()) cRef.set(CONFIG.criteria); });
      // Live roster & results
      state.db.ref(`${basePath()}/students`).on('value', snap=>{
        cacheStudents = snap.val() || {};
        renderResults(cacheStudents);
      });
    }

    // ===== JOIN / LIVE PRESENCE =====
    function ensureClientId(){
      let id = localStorage.getItem('present_uid');
      if(!id){ id = uid(); localStorage.setItem('present_uid', id); }
      state.me.id = id; return id;
    }
    async function joinClass(name){
      ensureClientId(); state.me.name = name;
      $('#whoami').textContent = name; show($('#rateCard'), true); show($('#joinCard'), false);

      const id = state.me.id;
      state.studentRef = state.db.ref(`${basePath()}/students/${id}`);

      // Seed scores at 1 for visibility
      const seed = Object.fromEntries(CONFIG.criteria.map(c => [c.id, 1]));
      await state.studentRef.set({ name, scores: seed });

      // TRUE presence: remove node when tab closes/disconnects
      try { state.studentRef.onDisconnect().remove(); } catch (e) {}

      // Also remove on refresh/unload (so they rejoin clean)
      window.addEventListener('beforeunload', () => {
        try { state.studentRef.remove(); } catch(e) {}
      });

      renderSliders(); // make sliders immediately usable
    }

    // ===== SLIDERS (instant write-through) =====
    function renderSliders(){
      const wrap = $('#criteriaList'); wrap.innerHTML = '';
      CONFIG.criteria.forEach((c, idx)=>{
        const div = document.createElement('div');
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <div style="font-weight:600">${idx+1}. ${c.label}</div>
            <div class="mut">1–${MAX_SCORE}</div>
          </div>
          <input type="range" min="1" max="${MAX_SCORE}" step="1" value="1" data-crit="${c.id}">
          <div class="mut" style="text-align:right;margin-top:4px">Score: <strong data-val="${c.id}">1</strong></div>`;
        wrap.appendChild(div);
      });

      wrap.querySelectorAll('input[type=range]').forEach(r=>{
        r.oninput = ()=>{
          const id = r.dataset.crit;
          const v = Number(r.value);
          wrap.querySelector(`[data-val="${id}"]`).textContent = v;
          if(state.studentRef) state.studentRef.child(`scores/${id}`).set(v);
        };
      });
    }

    // ===== RESULTS (live-only) =====
    function renderResults(students){
      const pool = Object.values(students || {}); // everyone with an open page
      $('#participantsBadge').textContent = `${pool.length} participants`;
      $('#participantsList').textContent = pool.map(s=> s && s.name ? s.name : '—').join(', ');

      // Per-category averages
      const res = CONFIG.criteria.map(c=>{
        const vals = pool.map(s => Number((s.scores||{})[c.id] || 0));
        return { label:c.label, avg: mean(vals) };
      });

      const box = $('#resultsSummary'); box.innerHTML = '';
      res.forEach(a=>{
        const row = document.createElement('div');
        row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center';
        row.innerHTML = `<div>${a.label}</div><div style="font-weight:600">${(a.avg||0).toFixed(2)} / ${MAX_SCORE}</div>`;
        box.appendChild(row);
      });

      // Final average (mean of category avgs)
      const finalAvg = mean(res.map(a=> a.avg || 0));
      $('#finalAverage').textContent = (finalAvg||0).toFixed(2);

      // Class total average (mean of each student's sum)
      const totals = pool.map(s => CONFIG.criteria.reduce((sum,c)=> sum + Number((s.scores||{})[c.id] || 0), 0));
      const maxTot = CONFIG.criteria.length * MAX_SCORE;
      $('#classTotalAvg').textContent = `${(mean(totals)||0).toFixed(2)} / ${maxTot}`;
      $('#maxTotal').textContent = maxTot;
    }

    // ===== TEACHER CONTROLS =====
    function resetSession(){
      if(!state.db) return;
      if(!confirm('Reset session? (Kicks everyone off and clears scores.)')) return;
      state.db.ref(`${basePath()}/students`).set({});
    }

    // ===== UI WIRES =====
    window.addEventListener('load', ()=> { dbInit(); });

    $('#joinBtn').onclick = ()=>{
      const name = $('#nameInput').value.trim();
      if(!name){ $('#joinStatus').textContent='Enter a name.'; return; }
      $('#joinStatus').textContent='';
      joinClass(name);
    };

    $('#loginBtn').onclick = ()=> $('#loginDlg').showModal();
    $('#unlockBtn').onclick = (e)=>{
      e.preventDefault();
      if($('#pinInput').value === CONFIG.teacherPin){ show($('#resultsCard'), true); $('#loginDlg').close(); }
      else alert('Wrong PIN');
    };

    $('#resetSession').onclick = resetSession;
  </script>
</body>
</html>