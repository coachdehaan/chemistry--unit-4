<!DOCTYPE html><html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presentation – Live Class Rater</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{fontFamily:{sans:["Inter","ui-sans-serif","system-ui"]}}}};</script>
  <!-- Firebase SDKs (Compat for simplicity) -->
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    .card{ background:#fff;border-radius:1rem;box-shadow:0 1px 6px rgba(0,0,0,.08);padding:1.25rem;}
    .btn{ padding:.5rem 1rem;border-radius:.75rem;box-shadow:0 1px 4px rgba(0,0,0,.08);font-size:.9rem;font-weight:600;background:#111;color:#fff;}
    .btn-ghost{ padding:.5rem .75rem;border-radius:.75rem;font-size:.9rem;font-weight:600;}
    .tab{ padding:.5rem 1rem;border-radius:.75rem;font-size:.9rem;font-weight:700;cursor:pointer;}
    .tab-active{ background:#111;color:#fff;}
    dialog::backdrop{ background: rgba(0,0,0,0.45); }
    .badge{font-size:.7rem;padding:.25rem .5rem;border-radius:9999px;background:#f3f4f6}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-5xl mx-auto p-4">
    <header class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Presentation – Live Class Rater</h1>
      <div class="flex items-center gap-2">
        <span id="connectionBadge" class="badge">offline (local)</span>
        <button id="loginBtn" class="btn-ghost" title="Teacher login">Login</button>
      </div>
    </header><main class="grid md:grid-cols-3 gap-4">
  <!-- Student panel (always visible) -->
  <section class="md:col-span-2 space-y-4">
    <div id="joinCard" class="card">
      <h2 class="font-semibold mb-2">Join</h2>
      <label class="block text-sm mb-1">Your name</label>
      <input id="nameInput" class="w-full border rounded-xl px-3 py-2" placeholder="e.g., Jane S." />
      <div class="flex items-center gap-2 mt-3">
        <button id="joinBtn" class="btn">Join & Rate</button>
        <span id="joinStatus" class="text-sm"></span>
      </div>
    </div>

    <div id="rateCard" class="card hidden">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Rate (1–10)</h2>
        <div class="text-sm">You: <span id="whoami" class="font-semibold">—</span></div>
      </div>
      <div id="criteriaList" class="mt-3 space-y-4"></div>
      <div class="mt-3 flex items-center justify-between text-sm">
        <div>Your total: <span id="totalScore" class="font-semibold">0</span></div>
        <div class="flex items-center gap-2">
          <button id="submitBtn" class="btn">Submit</button>
          <span id="submitNote" class="text-gray-600"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Results (teacher-only unless unlocked) -->
  <aside id="resultsCard" class="card md:col-span-1 hidden">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-semibold">Results</h2>
      <span id="participantsBadge" class="badge">0 participants</span>
    </div>
    <div class="text-xs text-gray-600 mb-2" id="resultModeNote">Showing averages of submitted ratings.</div>
    <div id="resultsSummary" class="space-y-2 text-sm"></div>
    <div class="border-t mt-3 pt-3 text-sm">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Final average</div>
        <div class="font-bold text-lg" id="finalAverage">0.00</div>
      </div>
    </div>
    <div class="mt-3 flex items-center gap-2">
      <button id="resetScores" class="btn-ghost">Reset scores</button>
      <button id="resetAll" class="btn-ghost">Reset ALL</button>
    </div>
  </aside>
</main>

  </div>  <!-- Teacher login modal -->  <dialog id="loginDlg" class="rounded-2xl w-full max-w-sm">
    <form method="dialog" class="p-5 space-y-4">
      <h3 class="text-lg font-semibold">Teacher Login</h3>
      <p class="text-sm text-gray-600">Enter PIN to unlock the Results panel. Share this PIN if you want the class to see results live.</p>
      <input id="pinInput" type="password" class="w-full border rounded-xl px-3 py-2" placeholder="PIN" />
      <div class="flex items-center gap-2">
        <button id="unlockBtn" class="btn" value="unlock">Unlock</button>
        <button class="btn-ghost" value="cancel">Close</button>
      </div>
    </form>
  </dialog>  <script>
    // ===== CONFIG (edit here) =====
    const CONFIG = {
      classKey: "chem_presentation", // change per period/session
      teacherPin: "2468",            // change your PIN
      useFirebase: true,              // true for live multi-device sync
      firebaseConfig: {
        apiKey: "AIzaSyAal8uHe9nePGimXiRPZAnBl0ucQlKnXNo",
        authDomain: "presentation-83d1f.firebaseapp.com",
        databaseURL: "https://presentation-83d1f-default-rtdb.firebaseio.com",
        projectId: "presentation-83d1f",
        storageBucket: "presentation-83d1f.firebasestorage.app",
        messagingSenderId: "132406143951",
        appId: "1:132406143951:web:9695690023bd3f2aedc0ba"
      },
      criteria: [
        { id: uid(), label: "Content Accuracy" },
        { id: uid(), label: "Clarity" },
        { id: uid(), label: "Visuals" },
        { id: uid(), label: "Engagement" },
        { id: uid(), label: "Delivery" }
      ],
      presenceTimeoutMs: 120000 // 2 minutes: who counts as "on"
    };

    const MAX_SCORE = 10;

    // ===== STATE =====
    const state = { db:null, me:{id:null,name:null}, online:false, submitted:false };
    const basePath = () => `/classes/${CONFIG.classKey}`;

    // ===== UTIL =====
    const $ = sel=>document.querySelector(sel); const $$=sel=>Array.from(document.querySelectorAll(sel));
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function mean(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
    function now(){ return Date.now(); }

    function show(el, on){ el.classList.toggle('hidden', !on); }
    function badge(txt){ $('#connectionBadge').textContent = txt; }

    // ===== INIT FIREBASE =====
    function dbInit(){
      if(!CONFIG.useFirebase){ badge('offline (local)'); return; }
      try {
        firebase.initializeApp(CONFIG.firebaseConfig);
        state.db = firebase.database();
        firebase.auth().signInAnonymously().then(()=>{
          state.online = true; badge('online (firebase)');
          attachListeners();
        }).catch(()=>{ state.online=false; badge('offline (local)'); });
      } catch(e){ state.online=false; badge('offline (local)'); }
    }

    // ===== JOIN / PRESENCE =====
    function ensureClientId(){
      let id = localStorage.getItem('present_uid');
      if(!id){ id = uid(); localStorage.setItem('present_uid', id); }
      state.me.id = id; return id;
    }

    function joinClass(name){
      ensureClientId(); state.me.name = name; state.submitted=false;
      $('#whoami').textContent = name; show($('#rateCard'), true); show($('#joinCard'), false);
      // seed scores to 1 for each criterion so sliders show a value
      const scores = Object.fromEntries(CONFIG.criteria.map(c=>[c.id,1]));
      saveStudent({ name, scores, submitted:false, lastSeen: now() });
      // start presence pings
      startPresence();
    }

    function startPresence(){
      if(!state.db) return; // only meaningful online
      setInterval(()=>{
        state.db.ref(`${basePath()}/students/${state.me.id}/lastSeen`).set(now());
      }, 20000); // 20s heartbeat
    }

    function saveStudent(patch){
      if(state.db){
        const ref = state.db.ref(`${basePath()}/students/${state.me.id}`);
        ref.update(patch);
      }
    }

    // ===== LISTENERS (results live) =====
    function attachListeners(){
      // Make sure criteria exist in DB (once)
      const cRef = state.db.ref(`${basePath()}/criteria`);
      cRef.once('value').then(s=>{ if(!s.exists()) cRef.set(CONFIG.criteria); });

      // live results
      state.db.ref(`${basePath()}/students`).on('value', snap=>{
        const students = snap.val()||{};
        renderResults(students);
      });
    }

    // ===== RENDER: criteria sliders =====
    function renderSliders(){
      const wrap = $('#criteriaList'); wrap.innerHTML = '';
      CONFIG.criteria.forEach((c,idx)=>{
        const row = document.createElement('div');
        row.innerHTML = `
          <div class="flex items-center justify-between mb-1"><div class="text-sm font-medium">${idx+1}. ${c.label}</div><div class="text-xs text-gray-500">1–${MAX_SCORE}</div></div>
          <input type="range" min="1" max="${MAX_SCORE}" step="1" value="1" data-crit="${c.id}" class="w-full"/>
          <div class="text-right text-sm mt-1">Score: <span data-val="${c.id}" class="font-semibold">1</span></div>`;
        wrap.appendChild(row);
      });

      wrap.querySelectorAll('input[type=range]').forEach(r=>{
        r.oninput = ()=>{
          const id = r.dataset.crit; const v = Number(r.value);
          wrap.querySelector(`[data-val="${id}"]`).textContent = v;
          updateMyTotal();
          if(!state.submitted) saveStudent({ [`scores/${id}`]: v }); // rolling updates until submit
        };
      });
      updateMyTotal();
    }

    function updateMyTotal(){
      const values = $$('#criteriaList input[type=range]').map(r=> Number(r.value));
      const sum = values.reduce((a,b)=>a+b,0);
      $('#totalScore').textContent = sum.toFixed(1);
    }

    // ===== RESULTS =====
    function renderResults(students){
      // Filter who counts: submitted==true OR (optionally) active presence
      const nowTs = now();
      const active = Object.values(students).filter(s=> s && (s.submitted===true) && (nowTs-(s.lastSeen||0) < CONFIG.presenceTimeoutMs));
      $('#participantsBadge').textContent = `${active.length} participants`;

      const res = CONFIG.criteria.map(c=>{
        const vals = active.map(s=> Number((s.scores||{})[c.id]||0)).filter(v=>v>0);
        return { label: c.label, avg: mean(vals) };
      });

      const box = $('#resultsSummary'); box.innerHTML='';
      res.forEach(a=>{
        const row=document.createElement('div'); row.className='flex items-center justify-between';
        row.innerHTML = `<div>${a.label}</div><div class="font-semibold">${(a.avg||0).toFixed(2)} / ${MAX_SCORE}</div>`;
        box.appendChild(row);
      });
      const finalAvg = mean(res.map(a=> a.avg||0));
      $('#finalAverage').textContent = (finalAvg||0).toFixed(2);
    }

    // ===== RESET =====
    function resetScores(){ if(!state.db) return; if(!confirm('Reset scores (keep current participants)?')) return;
      const ref = state.db.ref(`${basePath()}/students`);
      ref.once('value').then(s=>{ const obj=s.val()||{}; Object.keys(obj).forEach(id=>{ if(obj[id]){ obj[id].scores={}; obj[id].submitted=false; }}); ref.set(obj); });
    }
    function resetAll(){ if(!state.db) return; if(!confirm('Reset ALL (clear participants & scores)?')) return;
      state.db.ref(basePath()).set({ criteria: CONFIG.criteria, students: {} });
    }

    // ===== UI WIRES =====
    $('#joinBtn').onclick = ()=>{
      const name = $('#nameInput').value.trim();
      if(!name){ $('#joinStatus').textContent='Enter a name.'; return; }
      $('#joinStatus').textContent='';
      joinClass(name);
      renderSliders();
    };

    $('#submitBtn').onclick = ()=>{
      state.submitted = true;
      saveStudent({ submitted:true });
      // lock sliders visually
      $$('#criteriaList input[type=range]').forEach(r=> r.disabled = true);
      $('#submitNote').textContent = 'Submitted. You can still view your scores.';
    };

    $('#loginBtn').onclick = ()=> $('#loginDlg').showModal();
    $('#unlockBtn').onclick = (e)=>{
      e.preventDefault();
      if($('#pinInput').value === CONFIG.teacherPin){
        show($('#resultsCard'), true);
        $('#loginDlg').close();
      } else { alert('Wrong PIN'); }
    };

    $('#resetScores').onclick = resetScores;
    $('#resetAll').onclick = resetAll;

    // Boot
    window.addEventListener('load',()=>{ dbInit(); });
  </script></body>
</html>